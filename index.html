<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGram | WebRTC</title>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        /* ... (–í–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ WebGram) ... */
        :root {
            --tg-blue: #0088CC; 
            --tg-dark: #1F2C3D; 
            --tg-bg: #1A2433; 
            --tg-text: #E0E0E0; 
            --tg-accent: #65A30D; 
            --tg-message-self: #4A9C4A; 
            --tg-message-other: #334455; 
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ... (–°—Ç–∏–ª–∏ –¥–ª—è #registration-screen, #chat-container, #chat-list-panel, #main-chat) ... */
        #registration-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--tg-bg);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; text-align: center;
        }
        #chat-container { display: none; flex-grow: 1; display: flex; }
        #chat-list-panel { width: 350px; min-width: 250px; background-color: var(--tg-dark); border-right: 1px solid #333; overflow-y: auto; flex-shrink: 0; position: relative; }
        #main-chat { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--tg-bg); }
        #chat-list li.active { background-color: var(--tg-blue); color: white; }
        #chat-header { padding: 15px; background-color: var(--tg-dark); border-bottom: 1px solid #333; font-size: 1.1em; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #messages { flex-grow: 1; padding: 10px 15px; overflow-y: auto; display: flex; flex-direction: column; }
        .message { max-width: 60%; margin-bottom: 8px; padding: 8px 12px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; font-size: 0.95em; }
        .message.self { background-color: var(--tg-message-self); align-self: flex-end; color: white; border-bottom-right-radius: 4px; }
        .message.other { background-color: var(--tg-message-other); align-self: flex-start; color: var(--tg-text); border-bottom-left-radius: 4px; }
        
        /* --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ó–≤–æ–Ω–∫–∞ (WebRTC View) --- */
        #call-modal {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        #call-video-container {
            position: relative;
            width: 80%;
            max-width: 900px;
            height: 60%;
            background-color: #111;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #local-video {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 150px;
            height: 100px;
            background-color: #333;
            border: 2px solid white;
            border-radius: 5px;
            z-index: 10;
        }

        #remote-video {
            width: 100%;
            height: 100%;
            background-color: #222;
        }
        
        #call-controls button.red { background-color: #D9534F; }
        #call-controls button {
            background-color: var(--tg-blue);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 50%;
            margin: 10px;
            cursor: pointer;
            font-size: 1.2em;
        }
    </style>
</head>
<body>

    <div id="registration-screen">
        <h1>WebGram | WebRTC</h1>
        <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º –¥–ª—è –≤—Ö–æ–¥–∞:</p>
        <input type="text" id="nickname-input" placeholder="–ù–∏–∫–Ω–µ–π–º" maxlength="15">
        <button id="register-button">–í–æ–π—Ç–∏</button>
        <div id="registration-error" style="color: red; margin-top: 10px;"></div>
    </div>

    <div id="chat-container">
        
        <div id="chat-list-panel">
            <h3>üë• –ß–∞—Ç—ã</h3>
            <ul id="chat-list">
                <li id="general-chat-item" class="active" data-recipient="–æ–±—â–µ–µ">–û–±—â–∏–π –ß–∞—Ç</li>
            </ul>
        </div>

        <div id="main-chat">
            <div id="chat-header">
                <button class="menu-toggle" id="menu-toggle-btn">‚ò∞</button>
                <span id="current-chat-title">–û–±—â–∏–π –ß–∞—Ç</span>
                <span style="font-size: 0.8em; color: var(--tg-accent);">Online</span>
            </div>
            
            <div id="messages"></div>

            <form id="input-form">
                <textarea id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <div id="call-modal">
        <h2 id="call-status"></h2>
        <p id="call-partner"></p>

        <div id="call-video-container">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay muted playsinline></video>
        </div>

        <div id="call-controls">
            <button id="toggle-video" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ">üìπ</button>
            <button id="toggle-audio" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω">üéôÔ∏è</button>
            <button id="end-call-btn" class="red" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫">üìû</button>
        </div>
    </div>

    <script>
        // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ WebRTC/–°–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ ---
        let localStream;
        let peerConnection;
        let isCalling = false;
        let currentCallTarget = null;
        let isVideoOn = true;
        let isAudioOn = true;
        const STUN_SERVERS = {
            iceServers: [
                // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω—ã—Ö STUN-—Å–µ—Ä–≤–µ—Ä–æ–≤ Google (–¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è)
                { urls: 'stun:stun.l.google.com:19302' }, 
            ]
        };
        
        // --- –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–û—Å—Ç–∞–≤–ª–µ–Ω—ã) ---
        const socket = io({ transports: ['websocket'] });
        let myNickname = '';
        let currentRecipient = '–æ–±—â–µ–µ';
        let allUsers = []; 
        const messageStore = { '–æ–±—â–µ–µ': [] };

        // --- DOM —ç–ª–µ–º–µ–Ω—Ç—ã (–û–±–Ω–æ–≤–ª–µ–Ω—ã) ---
        const regScreen = document.getElementById('registration-screen');
        const chatContainer = document.getElementById('chat-container');
        const chatListPanel = document.getElementById('chat-list-panel');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        // ... –¥—Ä—É–≥–∏–µ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã ...
        
        // --- DOM —ç–ª–µ–º–µ–Ω—Ç—ã WebRTC ---
        const callModal = document.getElementById('call-modal');
        const callStatus = document.getElementById('call-status');
        const callPartner = document.getElementById('call-partner');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const endCallBtn = document.getElementById('end-call-btn');
        const toggleVideoBtn = document.getElementById('toggle-video');
        const toggleAudioBtn = document.getElementById('toggle-audio');


        // --- –§–£–ù–ö–¶–ò–ò WEBRTC ---
        
        // 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫–∞ (–∫–∞–º–µ—Ä–∞/–º–∏–∫—Ä–æ—Ñ–æ–Ω)
        async function getLocalMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                return true;
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –º–µ–¥–∏–∞-–¥–æ—Å—Ç—É–ø–∞:", err);
                alert("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.");
                return false;
            }
        }

        // 2. –°–æ–∑–¥–∞–Ω–∏–µ RTCPeerConnection –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        function createPeerConnection(isCaller) {
            peerConnection = new RTCPeerConnection(STUN_SERVERS);
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫–∞
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–±–æ—Ä–∞ ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç –ø–∞—Ä—Ç–Ω–µ—Ä—É —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
                    socket.emit('webrtc_ice', {
                        target: currentCallTarget,
                        candidate: event.candidate,
                    });
                }
            };
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            peerConnection.oniceconnectionstatechange = (event) => {
                console.log(`ICE state: ${peerConnection.iceConnectionState}`);
            };
            
            return peerConnection;
        }

        // 3. –°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ Offer
        async function sendOffer() {
            peerConnection = createPeerConnection(true);
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º SDP Offer –ø–∞—Ä—Ç–Ω–µ—Ä—É —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä
            socket.emit('webrtc_offer', {
                target: currentCallTarget,
                sdp: peerConnection.localDescription,
            });
        }

        // 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ Offer –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ Answer
        async function handleOffer(offerSdp) {
            peerConnection = createPeerConnection(false);
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offerSdp));
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º SDP Answer –ø–∞—Ä—Ç–Ω–µ—Ä—É —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä
            socket.emit('webrtc_answer', {
                target: currentCallTarget,
                sdp: peerConnection.localDescription,
            });
        }

        // 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ Answer
        async function handleAnswer(answerSdp) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answerSdp));
        }

        // 6. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ WebRTC-–∑–≤–æ–Ω–∫–∞
        function stopWebRTC() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
        }
        
        
        // --- –§–£–ù–ö–¶–ò–ò –ó–í–û–ù–ö–ê (UI/–õ–û–ì–ò–ö–ê) ---

        // 1. –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞ (–∑–∞–ø—É—Å–∫ WebRTC)
        async function initiateCall() {
            if (currentRecipient === '–æ–±—â–µ–µ' || isCalling) return;
            
            if (!(await getLocalMedia())) return; // –ó–∞–ø—Ä–æ—Å –º–µ–¥–∏–∞-–¥–æ—Å—Ç—É–ø–∞

            isCalling = true;
            currentCallTarget = currentRecipient;

            callStatus.textContent = '–ò–¥–µ—Ç –≤—ã–∑–æ–≤... (–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞)';
            callPartner.textContent = `–ó–≤–æ–Ω–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: ${currentCallTarget}`;
            callModal.style.display = 'flex';
            
            // –ó–∞–ø—É—Å–∫ WebRTC Offer
            await sendOffer();
        }

        // 2. –û—Ç–≤–µ—Ç –Ω–∞ –∑–≤–æ–Ω–æ–∫ (–≤—Ö–æ–¥—è—â–∏–π)
        async function answerCall(offerSdp) {
            if (!(await getLocalMedia())) return; // –ó–∞–ø—Ä–æ—Å –º–µ–¥–∏–∞-–¥–æ—Å—Ç—É–ø–∞
            
            isCalling = true;
            
            // –°–æ–∑–¥–∞–Ω–∏–µ Answer –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ
            await handleOffer(offerSdp);
            
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞, —á—Ç–æ –∑–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç
            socket.emit('call_accepted', currentCallTarget);
            
            callStatus.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!';
            callPartner.textContent = `–í—ã –≤ —á–∞—Ç–µ —Å ${currentCallTarget}`;
            
            // ... (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI) ...
        }
        
        // 3. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
        function endCall() {
            if (!isCalling) return;

            socket.emit('call_end', currentCallTarget);
            
            stopWebRTC(); // –û—á–∏—Å—Ç–∫–∞ WebRTC-–æ–±—ä–µ–∫—Ç–æ–≤
            
            callStatus.textContent = '–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω.';
            addMessageToStore(currentCallTarget, { type: 'system', content: `üìû –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω.` });
            loadChat(currentRecipient);

            setTimeout(() => {
                callModal.style.display = 'none';
                isCalling = false;
                currentCallTarget = null;
            }, 1500);
        }
        
        // 4. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–¥–∏–∞-–¥–æ—Ä–æ–∂–µ–∫
        toggleVideoBtn.onclick = () => {
            if (localStream) {
                isVideoOn = !isVideoOn;
                localStream.getVideoTracks().forEach(track => track.enabled = isVideoOn);
                toggleVideoBtn.textContent = isVideoOn ? 'üìπ' : '‚¨õ';
            }
        };

        toggleAudioBtn.onclick = () => {
            if (localStream) {
                isAudioOn = !isAudioOn;
                localStream.getAudioTracks().forEach(track => track.enabled = isAudioOn);
                toggleAudioBtn.textContent = isAudioOn ? 'üéôÔ∏è' : 'üîá';
            }
        };
        
        endCallBtn.onclick = endCall;

        // ... (–í–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ loadChat, updateChatList, etc.) ...
        
        // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ loadChat (–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–ó–≤–æ–Ω–æ–∫") ---
        function loadChat(recipient) {
            // ... (–í–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ loadChat) ...
            
            currentRecipient = recipient;
            messagesDiv.innerHTML = '';
            
            const headerContent = document.getElementById('chat-header');
            
            if (recipient === '–æ–±—â–µ–µ') {
                // ... (–û–±—â–∏–π —á–∞—Ç) ...
            } else {
                headerContent.innerHTML = `
                    <button class="menu-toggle" id="menu-toggle-btn">‚ò∞</button>
                    <span id="current-chat-title">–ß–∞—Ç —Å ${recipient}</span>
                    <button id="initiate-call-btn" style="background: none; border: none; color: var(--tg-accent); cursor: pointer; font-size: 1.5em; padding: 0;" title="–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫">üìû</button>
                `;
                document.getElementById('menu-toggle-btn').onclick = () => chatListPanel.classList.toggle('active');
                document.getElementById('initiate-call-btn').onclick = initiateCall;
            }

            // ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ loadChat) ...
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Socket.io (–°–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è WebRTC) ---

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∑–≤–æ–Ω–∫–∞ (Offer)
        socket.on('incoming_call', ({ callerNickname, offerSdp }) => {
            if (isCalling) {
                socket.emit('call_busy', callerNickname);
                return;
            }
            
            currentCallTarget = callerNickname;
            
            callStatus.textContent = '–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫!';
            callPartner.textContent = `–ó–≤–æ–Ω–∏—Ç: ${callerNickname}`;
            callModal.style.display = 'flex';
            
            document.getElementById('call-status').onclick = () => {
                 // –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ –∑–≤–æ–Ω–æ–∫
                 answerCall(offerSdp);
            };
            
            // –í —Ä–µ–∞–ª—å–Ω–æ–º UI –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–Ω—è—Ç—å/–û—Ç–∫–ª–æ–Ω–∏—Ç—å"
            alert(`–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ${callerNickname}. –ù–∞–∂–º–∏—Ç–µ –û–ö, —á—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å.`);
            answerCall(offerSdp); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–Ω–∏–º–∞–µ–º –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ (Answer)
        socket.on('webrtc_answer', async ({ answerSdp }) => {
            await handleAnswer(answerSdp);
            callStatus.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!';
            callPartner.textContent = `–í—ã –≤ —á–∞—Ç–µ —Å ${currentCallTarget}`;
            addMessageToStore(currentCallTarget, { type: 'system', content: `üìû –ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞—Ç.` });
            loadChat(currentCallTarget);
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–∞
        socket.on('webrtc_ice', async ({ candidate }) => {
            if (peerConnection) {
                try {
                    await peerConnection.addIceCandidate(candidate);
                } catch (e) {
                    console.error('Error adding received ICE candidate:', e);
                }
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        socket.on('call_ended', (partner) => {
            if (isCalling && currentCallTarget === partner) {
                callStatus.textContent = `${partner} –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫.`;
                endCall();
            }
        });
        
        // ... (–í–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏: registration_success, user_list, public_message, etc.) ...

    </script>
</body>
</html>
