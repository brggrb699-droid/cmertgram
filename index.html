<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CmertGramm ‚Äî –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä (Replit)</title>
<style>
  :root {
    --bg-light: #f9f9f9;
    --bg-dark: #1e1e1e;
    --text-light: #222;
    --text-dark: #ddd;
    --primary: #0088cc;
    --accent: #00bfff;
  }
  body.light {
    background: var(--bg-light);
    color: var(--text-light);
  }
  body.dark {
    background: var(--bg-dark);
    color: var(--text-dark);
  }
  #app {
    max-width: 900px;
    margin: 0 auto;
    height: 100vh;
    display: flex;
    flex-direction: column;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }
  header {
    padding: 10px;
    background: var(--primary);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #themeToggle {
    cursor: pointer;
    background: var(--accent);
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    color: white;
    font-weight: bold;
  }
  main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: inherit;
    color: inherit;
  }
  #chatWindow {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    border: 1px solid #ccc;
    background: inherit;
    display: flex;
    flex-direction: column;
  }
  .msg {
    margin-bottom: 10px;
    max-width: 70%;
    word-wrap: break-word;
    padding: 8px 12px;
    border-radius: 12px;
    position: relative;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .msg.self {
    background: #dcf8c6;
    align-self: flex-end;
    flex-direction: row-reverse;
  }
  .msg.other {
    background: #fff;
    align-self: flex-start;
  }
  .msg img {
    max-width: 200px;
    border-radius: 10px;
    display: block;
  }
  .msg audio {
    max-width: 200px;
    display: block;
  }
  .msg .msgText {
    flex: 1;
  }
  .msg .deleteBtn {
    cursor: pointer;
    font-weight: bold;
    color: #c0392b;
    background: transparent;
    border: none;
    font-size: 18px;
    line-height: 1;
    user-select: none;
  }
  #inputArea {
    padding: 10px;
    border-top: 1px solid #ccc;
    display: flex;
    gap: 6px;
  }
  #msgInput {
    flex: 1;
    padding: 8px;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #aaa;
  }
  button {
    cursor: pointer;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    background: var(--primary);
    color: white;
    font-weight: bold;
  }
  #clearChat {
    background: #e74c3c;
  }
  #userSettings {
    background: #eee;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    border-bottom: 1px solid #ccc;
  }
  #nicknameInput, #recipientInput { /* –î–û–ë–ê–í–õ–ï–ù #recipientInput */
    padding: 6px 8px;
    font-size: 1rem;
    border-radius: 6px;
    border: 1px solid #aaa;
    width: 180px;
  }
  #avatarPreview {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--primary);
  }
  #avatarURL {
    width: 200px;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #aaa;
  }
  #avatarFile {
    display: none;
  }
  #avatarFileLabel {
    cursor: pointer;
    background: var(--primary);
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: bold;
    user-select: none;
    transition: background 0.3s ease;
  }
  #avatarFileLabel:hover {
    background: var(--accent);
  }
  #voiceRecordBtn {
    background: #27ae60;
  }
  #callBtn {
    background: #2980b9;
  }
  #incomingCallModal {
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #222;
    color: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 15px #000;
    z-index: 1000;
    display: none;
    min-width: 300px;
  }
  #incomingCallModal button {
    margin-right: 10px;
    background: #3498db;
  }
  #incomingCallBackdrop {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 900;
    display: none;
  }
  #chatWindow::-webkit-scrollbar {
    width: 8px;
  }
  #chatWindow::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 4px;
  }
</style>
</head>
<body class="light">

<div id="app">
  <header>
    <div><strong>CmertGramm (Global Mode)</strong></div>
    <button id="themeToggle">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
  </header>

  <div id="userSettings">
    <input type="text" id="nicknameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫" maxlength="20" title="–í–∞—à –Ω–∏–∫" />
    <input type="text" id="recipientInput" placeholder="–ù–∏–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –¥–ª—è —Å–≤—è–∑–∏" maxlength="20" title="–ù–∏–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è" /> <input type="text" id="avatarURL" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∞ –∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º" title="URL –∞–≤–∞—Ç–∞—Ä–∞" />
    <input type="file" id="avatarFile" accept="image/*" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä" />
    <label for="avatarFile" id="avatarFileLabel" title="–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</label>
    <img id="avatarPreview" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="–ê–≤–∞—Ç–∞—Ä" title="–ü—Ä–µ–≤—å—é –∞–≤–∞—Ç–∞—Ä–∞" />
    <button id="saveUserBtn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>

  <main>
    <div id="chatWindow" aria-live="polite" aria-atomic="false"></div>
    <div id="inputArea">
      <input id="msgInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ" />
      <button id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button id="voiceRecordBtn" title="–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">üéôÔ∏è</button>
      <button id="callBtn" title="–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫">üìû</button>
      <button id="clearChat" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç —É —Å–µ–±—è">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
    </div>
  </main>
</div>

<div id="incomingCallBackdrop"></div>
<div id="incomingCallModal" role="dialog" aria-modal="true" aria-labelledby="callTitle" aria-describedby="callDesc">
  <h3 id="callTitle">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</h3>
  <p id="callDesc">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —Å –≤–∞–º–∏ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å. –ü—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫?</p>
  <button id="acceptCallBtn">–ü—Ä–∏–Ω—è—Ç—å</button>
  <button id="declineCallBtn">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
</div>

<script>
(() => {
  // --- –¢–µ–º–∞ ---
  const body = document.body;
  const themeToggle = document.getElementById('themeToggle');
  const savedTheme = localStorage.getItem('theme') || 'light';
  body.className = savedTheme;
  themeToggle.textContent = savedTheme === 'light' ? '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞' : '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';

  themeToggle.addEventListener('click', () => {
    if (body.classList.contains('light')) {
      body.classList.replace('light', 'dark');
      themeToggle.textContent = '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
      localStorage.setItem('theme', 'dark');
    } else {
      body.classList.replace('dark', 'light');
      themeToggle.textContent = '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
      localStorage.setItem('theme', 'light');
    }
  });

  // --- –Æ–∑–µ—Ä ---
  const nicknameInput = document.getElementById('nicknameInput');
  const recipientInput = document.getElementById('recipientInput'); // –ù–û–í–û–ï –ü–û–õ–ï
  const avatarURLInput = document.getElementById('avatarURL');
  const avatarFileInput = document.getElementById('avatarFile');
  const avatarPreview = document.getElementById('avatarPreview');
  const saveUserBtn = document.getElementById('saveUserBtn');

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
  let userData = JSON.parse(localStorage.getItem('userData')) || {
    nickname: '',
    avatar: 'https://cdn-icons-png.flaticon.com/512/149/149071.png'
  };
  nicknameInput.value = userData.nickname;
  avatarPreview.src = userData.avatar;
  avatarURLInput.value = userData.avatar.startsWith('blob:') ? '' : userData.avatar;
  recipientInput.value = localStorage.getItem('recipientNick') || ''; // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∏–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è

  avatarURLInput.addEventListener('input', () => {
    if (avatarURLInput.value.trim()) {
      avatarPreview.src = avatarURLInput.value.trim();
      userData.avatar = avatarURLInput.value.trim();
      localStorage.setItem('userData', JSON.stringify(userData));
    }
  });

  avatarFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
      return;
    }
    const reader = new FileReader();
    reader.onload = (ev) => {
      avatarPreview.src = ev.target.result;
      userData.avatar = ev.target.result;
      avatarURLInput.value = '';
      localStorage.setItem('userData', JSON.stringify(userData));
    };
    reader.readAsDataURL(file);
  });

  saveUserBtn.addEventListener('click', () => {
    const nick = nicknameInput.value.trim() || '–ê–Ω–æ–Ω–∏–º';
    userData.nickname = nick;
    if (avatarURLInput.value.trim()) {
      userData.avatar = avatarURLInput.value.trim();
    }
    localStorage.setItem('userData', JSON.stringify(userData));
    localStorage.setItem('recipientNick', recipientInput.value.trim()); // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
    
    // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º –Ω–∏–∫–æ–º
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
        connectWebSocket();
    } else if (!ws) {
        connectWebSocket();
    }
    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ï—Å–ª–∏ –≤—ã —Å–º–µ–Ω–∏–ª–∏ –Ω–∏–∫, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
  });
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∏–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ø—Ä–∏ –≤–≤–æ–¥–µ
  recipientInput.addEventListener('input', () => {
    localStorage.setItem('recipientNick', recipientInput.value.trim());
  });

  // --- –ß–∞—Ç ---
  const chatWindow = document.getElementById('chatWindow');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const clearChatBtn = document.getElementById('clearChat');

  // –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ localStorage (–û—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏, –Ω–æ —Å–µ—Ç–µ–≤–æ–π –ª–æ–≥–∏–∫–æ–π –Ω–µ —É–ø—Ä–∞–≤–ª—è–µ–º)
  let chatMessages = JSON.parse(localStorage.getItem('chatMessages')) || [];

  function renderMessages() {
    chatWindow.innerHTML = '';
    chatMessages.forEach(({id, from, avatar, text, img, audio, self}) => {
      const div = document.createElement('div');
      div.classList.add('msg');
      div.classList.add(self ? 'self' : 'other');
      div.dataset.id = id;

      // –ê–≤–∞—Ç–∞—Ä
      const imgAvatar = document.createElement('img');
      imgAvatar.src = avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
      imgAvatar.alt = from + ' avatar';
      imgAvatar.title = from;
      imgAvatar.style.width = '32px';
      imgAvatar.style.height = '32px';
      imgAvatar.style.borderRadius = '50%';

      // –ö–æ–Ω—Ç–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
      const contentDiv = document.createElement('div');
      contentDiv.classList.add('msgText');
      if (text) contentDiv.textContent = text;
      if (img) {
        const imgel = document.createElement('img');
        imgel.src = img;
        contentDiv.innerHTML = '';
        contentDiv.appendChild(imgel);
      }
      if (audio) {
        const aud = document.createElement('audio');
        aud.controls = true;
        aud.src = audio;
        contentDiv.innerHTML = '';
        contentDiv.appendChild(aud);
      }
      
      // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏)
      const delBtn = document.createElement('button');
      delBtn.className = 'deleteBtn';
      delBtn.title = '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ';
      delBtn.textContent = '√ó';
      delBtn.addEventListener('click', () => {
        chatMessages = chatMessages.filter(m => m.id !== id);
        localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
        renderMessages();
      });

      div.appendChild(imgAvatar);
      div.appendChild(contentDiv);
      div.appendChild(delBtn);

      chatWindow.appendChild(div);
    });

    // –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  renderMessages();

  function addMessage(msgObj) {
    chatMessages.push(msgObj);
    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–∏—Ç—å localStorage
    if (chatMessages.length > 50) {
        chatMessages = chatMessages.slice(chatMessages.length - 50);
    }
    localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
    renderMessages();
  }
  
  // --- WebSocket & –°–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è ---
  // –í–ù–ò–ú–ê–ù–ò–ï: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–π URL –≤–∞—à–µ–≥–æ Repl, –Ω–∞–ø—Ä–∏–º–µ—Ä: 'wss://my-cmertgram.repl.co'
  const REPLIT_WS_URL = `wss://${window.location.host}`; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π —Ö–æ—Å—Ç –¥–ª—è Replit
  let ws = null;
  let isWsConnected = false;
  
  function encodePayload(data) {
      return btoa(JSON.stringify(data)); 
  }
  
  function sendSignal(type, payload) {
      if (!isWsConnected || ws.readyState !== WebSocket.OPEN) {
          alert('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º Replit –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∏–∫.');
          return;
      }
      
      const recipient = recipientInput.value.trim();
      if (!recipient && (type === 'msg' || type.startsWith('call-'))) {
          alert('–í–≤–µ–¥–∏—Ç–µ –ù–∏–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –∑–≤–æ–Ω–∫–∞.');
          return;
      }
      
      const finalPayload = {
          from: userData.nickname || '–ê–Ω–æ–Ω–∏–º',
          avatar: userData.avatar,
          recipient_nick: recipient, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∏–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
          ...payload,
          type: type
      };
      
      ws.send(encodePayload(finalPayload));
      
      // –î–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –æ—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è, –Ω–æ –Ω–µ –¥–ª—è —Å–∏–≥–Ω–∞–ª–æ–≤
      if (type === 'msg' && payload.text) {
        msgInput.value = '';
      }
  }
  
  function connectWebSocket() {
      if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
          return;
      }
      
      const host = window.location.host;
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º wss –¥–ª—è Replit, –µ—Å–ª–∏ —Ö–æ—Å—Ç –Ω–µ –ª–æ–∫–∞–ª—å–Ω—ã–π. 
      const protocol = (host.includes('localhost') || host.includes('127.0.0.1')) ? 'ws' : 'wss';
      const url = `${protocol}://${host}`;
      
      ws = new WebSocket(url);
      
      ws.onopen = () => {
          isWsConnected = true;
          console.log('[STEALTH] WebSocket: –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ Repl.co.');
          
          const initPayload = {
              type: 'init',
              nickname: userData.nickname || '–ê–Ω–æ–Ω–∏–º',
              avatar: userData.avatar
          };
          // –û—Ç–ø—Ä–∞–≤–∫–∞ INIT-–ø–∞–∫–µ—Ç–∞ —Å –Ω–∏–∫–æ–º
          ws.send(encodePayload(initPayload)); 
      };

      ws.onmessage = async (event) => {
          const encrypted_data = event.data;
          let data;
          try {
              data = JSON.parse(atob(encrypted_data)); 
          } catch (e) {
              console.error('[BYPASS] –ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å/—Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.');
              return;
          }

          // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–ß–ê–¢ –ò –°–ò–ì–ù–ê–õ–ò–ù–ì) ---
          switch (data.type) {
              case 'msg':
                  // –í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –î–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –≤–∞—à –ª–æ–∫–∞–ª—å–Ω—ã–π —á–∞—Ç.
                  addMessage({
                      id: Date.now(),
                      from: data.from,
                      avatar: data.avatar,
                      text: data.text || null,
                      audio: data.audio || null,
                      self: false // –≠—Ç–æ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                  });
                  break;
                  
              case 'status':
              case 'error':
                  alert(data.text);
                  break;
              
              case 'call-offer':
                  if (isCalling) {
                      sendSignal('call-busy', { recipient_nick: data.from });
                      return;
                  }
                  currentCall = data;
                  document.getElementById('callTitle').textContent = `–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ${data.from}`;
                  incomingCallModal.style.display = 'block';
                  incomingCallBackdrop.style.display = 'block';
                  break;

              case 'call-answer':
                  if (!isCalling || !peerConnection) return;
                  await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                  alert('–ó–≤–æ–Ω–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –ú–æ–∂–µ—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å.');
                  break;

              case 'ice-candidate':
                  if (peerConnection) {
                      try {
                          await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                      } catch (err) {
                          console.warn('[ERROR] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞', err);
                      }
                  }
                  break;
              
              case 'call-decline':
                  alert('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω—ë–Ω –∏–ª–∏ –∑–∞–≤–µ—Ä—à—ë–Ω');
                  endCall();
                  break;

              case 'call-busy':
                  alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–Ω—è—Ç –∑–≤–æ–Ω–∫–æ–º');
                  endCall();
                  break;
          }
      };

      ws.onclose = () => {
          isWsConnected = false;
          console.warn('[BYPASS] WebSocket: –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫...');
          setTimeout(connectWebSocket, 5000);
      };

      ws.onerror = (err) => {
          console.error('[ERROR] WebSocket:', err);
          ws.close();
      };
  }

  // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  window.addEventListener('load', connectWebSocket);


  // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ ---
  sendBtn.addEventListener('click', () => {
    const txt = msgInput.value.trim();
    if (!txt) return;
    
    // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    sendSignal('msg', { text: txt });
    
    // 2. –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ (—Å–∞–º–æ–º—É —Å–µ–±–µ)
    addMessage({
      id: Date.now(),
      from: userData.nickname || '–ê–Ω–æ–Ω–∏–º',
      avatar: userData.avatar,
      text: txt,
      self: true
    });
  });

  msgInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      sendBtn.click();
    }
  });

  // --- –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞ ---
  clearChatBtn.addEventListener('click', () => {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —É –≤–∞—Å.')) {
      chatMessages = [];
      localStorage.removeItem('chatMessages');
      renderMessages();
    }
  });

  // --- –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ---
  const voiceRecordBtn = document.getElementById('voiceRecordBtn');
  let mediaRecorder = null;
  let audioChunks = [];

  voiceRecordBtn.addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      voiceRecordBtn.textContent = 'üéôÔ∏è';
      voiceRecordBtn.title = '–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
      return;
    }

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ.');
      return;
    }
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = e => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const audioUrl = URL.createObjectURL(audioBlob);
          
          // 1. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          sendSignal('msg', { audio: audioUrl }); 

          // 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ
          addMessage({
            id: Date.now(),
            from: userData.nickname || '–ê–Ω–æ–Ω–∏–º',
            avatar: userData.avatar,
            audio: audioUrl,
            self: true
          });
          
          stream.getTracks().forEach(t => t.stop());
        };

        mediaRecorder.start();
        voiceRecordBtn.textContent = '‚ñ† –°—Ç–æ–ø';
        voiceRecordBtn.title = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
      })
      .catch(() => alert('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω.'));
  });

  // --- WebRTC –∑–≤–æ–Ω–∫–∏ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä ---
  const callBtn = document.getElementById('callBtn');
  const incomingCallModal = document.getElementById('incomingCallModal');
  const incomingCallBackdrop = document.getElementById('incomingCallBackdrop');
  const acceptCallBtn = document.getElementById('acceptCallBtn');
  const declineCallBtn = document.getElementById('declineCallBtn');

  let localStream = null;
  let peerConnection = null;
  let isCalling = false;
  let currentCall = null;

  const config = {
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
  };

  function createPeerConnection() {
    peerConnection = new RTCPeerConnection(config);

    peerConnection.onicecandidate = event => {
      if (event.candidate) {
        // –û—Ç–ø—Ä–∞–≤–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä
        sendSignal('ice-candidate', { candidate: event.candidate, recipient_nick: currentCall ? currentCall.from : recipientInput.value.trim() });
      }
    };

    peerConnection.ontrack = event => {
      let remoteAudio = document.getElementById('remoteAudio');
      if (!remoteAudio) {
        remoteAudio = document.createElement('audio');
        remoteAudio.id = 'remoteAudio';
        remoteAudio.autoplay = true;
        document.body.appendChild(remoteAudio);
        alert('–ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç. –í—ã —Å–ª—ã—à–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.');
      }
      remoteAudio.srcObject = event.streams[0];
    };

    peerConnection.onconnectionstatechange = () => {
      if (peerConnection.connectionState === 'disconnected' || peerConnection.connectionState === 'failed') {
        endCall();
        alert('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ.');
      }
    };
  }

  async function startCall() {
    if (isCalling) {
      alert('–ó–≤–æ–Ω–æ–∫ —É–∂–µ –∏–¥–µ—Ç');
      return;
    }
    const recipientNick = recipientInput.value.trim();
    if (!recipientNick) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è.');
        return;
    }

    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      createPeerConnection();

      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      // –û—Ç–ø—Ä–∞–≤–∫–∞ offer —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä
      sendSignal('call-offer', { offer, recipient_nick: recipientNick });
      isCalling = true;
      callBtn.disabled = true;
      alert(`–ó–≤–æ–Ω–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${recipientNick}. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞.`);
    } catch (e) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫: ' + e.message);
      endCall();
    }
  }

  function endCall() {
    if (peerConnection) {
      peerConnection.close();
      peerConnection = null;
    }
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }
    isCalling = false;
    callBtn.disabled = false;
    incomingCallModal.style.display = 'none';
    incomingCallBackdrop.style.display = 'none';

    const remoteAudio = document.getElementById('remoteAudio');
    if (remoteAudio) {
      remoteAudio.srcObject = null;
      remoteAudio.remove();
    }
  }
  
  // –ü—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫
  acceptCallBtn.addEventListener('click', async () => {
    incomingCallModal.style.display = 'none';
    incomingCallBackdrop.style.display = 'none';

    if (!currentCall) return;

    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      createPeerConnection();

      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });

      await peerConnection.setRemoteDescription(new RTCSessionDescription(currentCall.offer));
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);

      // –û—Ç–ø—Ä–∞–≤–∫–∞ answer —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä
      sendSignal('call-answer', { answer, recipient_nick: currentCall.from });
      
      isCalling = true;
      callBtn.disabled = true;
      currentCall = null;
    } catch (e) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–µ–º–µ –∑–≤–æ–Ω–∫–∞: ' + e.message);
      endCall();
    }
  });

  declineCallBtn.addEventListener('click', () => {
    if (currentCall) {
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞ –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏
        sendSignal('call-decline', { recipient_nick: currentCall.from });
        currentCall = null;
    }
    incomingCallModal.style.display = 'none';
    incomingCallBackdrop.style.display = 'none';
    endCall();
  });

  callBtn.addEventListener('click', startCall);

  window.addEventListener('beforeunload', () => {
    if (isCalling) {
      sendSignal('call-decline', { recipient_nick: currentCall ? currentCall.from : recipientInput.value.trim() });
      endCall();
    }
    if (ws) {
        ws.close();
    }
  });

})();
</script>

</body>
</html>
