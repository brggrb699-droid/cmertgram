<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowChat Lite</title>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    
    <style>
        :root {
            --color-primary: #FFD700; /* –ó–æ–ª–æ—Ç–∏—Å—Ç–æ-–∂–µ–ª—Ç—ã–π */
            --color-secondary: #007FFF; /* –Ø—Ä–∫–æ-—Å–∏–Ω–∏–π */
            --color-background: #1e1e1e; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            --color-text: #f0f0f0; /* –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç */
            --color-input: #333333;
            --color-system: #7F7F7F;
            --color-public-bg: #444444;
            --color-private-bg: #007FFF40; /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Å–∏–Ω–∏–π */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text);
            display: flex;
            height: 100vh;
            overflow: hidden;
            flex-direction: column;
        }

        /* –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
        #registration-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-background);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
        }

        #registration-screen h1 {
            color: var(--color-primary);
            margin-bottom: 30px;
        }

        #registration-screen input {
            padding: 10px;
            border: 2px solid var(--color-secondary);
            border-radius: 5px;
            background-color: var(--color-input);
            color: var(--color-text);
            font-size: 16px;
            margin-bottom: 10px;
            width: 80%;
            max-width: 300px;
        }

        #registration-screen button {
            background-color: var(--color-secondary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #registration-screen button:hover {
            background-color: #006ED0;
        }

        #registration-error {
            color: var(--color-primary);
            margin-top: 15px;
            font-weight: bold;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–∞—Ç–∞ */
        #chat-container {
            display: none; /* –°–∫—Ä—ã—Ç –¥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
            flex-direction: row;
            flex-grow: 1;
        }

        /* –ü–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        #users-panel {
            width: 250px;
            min-width: 200px;
            background-color: var(--color-input);
            padding: 15px;
            border-right: 1px solid var(--color-public-bg);
            overflow-y: auto;
            flex-shrink: 0;
        }

        #users-panel h3 {
            color: var(--color-primary);
            margin-top: 0;
            border-bottom: 1px solid var(--color-secondary);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        #users-list li {
            list-style: none;
            padding: 8px;
            margin-bottom: 5px;
            background-color: var(--color-background);
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--color-text);
        }

        #users-list li:hover {
            background-color: var(--color-secondary);
        }

        #users-list li.me {
            font-weight: bold;
            color: var(--color-primary);
        }
        
        #users-list li.selected {
            background-color: var(--color-secondary);
            color: white;
        }

        /* –ü–∞–Ω–µ–ª—å —á–∞—Ç–∞ */
        #main-chat {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        #chat-header {
            padding: 15px;
            background-color: var(--color-input);
            color: var(--color-primary);
            font-weight: bold;
            border-bottom: 1px solid var(--color-secondary);
            text-align: center;
        }

        #messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 15px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        /* –û–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message.public {
            background-color: var(--color-public-bg);
            align-self: flex-start;
        }
        
        .message.public.self {
            background-color: var(--color-secondary);
            align-self: flex-end;
            color: white;
        }

        /* –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message.private {
            background-color: var(--color-private-bg);
            border: 1px solid var(--color-secondary);
            align-self: flex-start;
            position: relative;
        }
        .message.private::before {
            content: 'üîí PRIVATE';
            position: absolute;
            top: -10px;
            left: 5px;
            font-size: 10px;
            color: var(--color-primary);
            background-color: var(--color-background);
            padding: 1px 5px;
            border-radius: 3px;
        }

        .message.private.self {
            align-self: flex-end;
            background-color: var(--color-secondary);
            color: white;
        }
        .message.private.self::before {
            left: auto;
            right: 5px;
        }
        
        /* –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message.system {
            align-self: center;
            background-color: transparent;
            color: var(--color-system);
            text-align: center;
            font-style: italic;
            padding: 5px;
        }
        .message.system span {
            font-weight: bold;
        }

        .message-sender {
            font-weight: bold;
            font-size: 0.9em;
            color: var(--color-primary);
            margin-bottom: 5px;
        }

        .message.public.self .message-sender,
        .message.private.self .message-sender {
            color: white;
        }

        .message-content {
            white-space: pre-wrap;
        }

        .message-time {
            display: block;
            margin-top: 5px;
            font-size: 0.7em;
            color: #ccc;
            text-align: right;
        }

        /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ */
        #input-form {
            display: flex;
            padding: 15px;
            background-color: var(--color-input);
            border-top: 1px solid var(--color-public-bg);
        }

        #message-input {
            flex-grow: 1;
            padding: 10px;
            border: 2px solid var(--color-background);
            border-radius: 5px;
            background-color: var(--color-background);
            color: var(--color-text);
            font-size: 16px;
            resize: none;
            height: 40px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        #message-input:focus {
            border-color: var(--color-secondary);
            outline: none;
        }

        #input-form button {
            margin-left: 10px;
            background-color: var(--color-secondary);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #input-form button:hover {
            background-color: #006ED0;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ */
        #recipient-indicator {
            position: absolute;
            top: 0px;
            left: 20%;
            right: 20%;
            background-color: var(--color-primary);
            color: var(--color-background);
            padding: 5px 10px;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
            font-weight: bold;
            font-size: 0.8em;
            text-align: center;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
    </style>
</head>
<body>

    <div id="registration-screen">
        <h1>ShadowChat Lite</h1>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º (–±–µ–∑ –ø–∞—Ä–æ–ª—è/email):</p>
        <input type="text" id="nickname-input" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" maxlength="15">
        <button id="register-button">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
        <div id="registration-error"></div>
    </div>

    <div id="chat-container">
        <div id="users-panel">
            <h3>üë• –û–Ω–ª–∞–π–Ω –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
            <ul id="users-list">
                </ul>
        </div>

        <div id="main-chat">
            <div id="chat-header">
                –û–±—â–∏–π –ß–∞—Ç (Default)
            </div>
            
            <div id="recipient-indicator">
                –í—ã –ø–∏—à–µ—Ç–µ: <span id="current-recipient"></span>. <a href="#" id="exit-private" style="color: var(--color-background); text-decoration: none;">[X] –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –û–±—â–∏–π</a>
            </div>

            <div id="messages">
                </div>

            <form id="input-form">
                <textarea id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <script>
        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        
        // !!! –í–ê–ñ–ù–û –¥–ª—è Render: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç–µ–∫—É—â–µ–º—É –¥–æ–º–µ–Ω—É
        const socket = io({
             transports: ['websocket'] 
        });

        const AES_KEY = '–≠—Ç–æ_–û—á–µ–Ω—å_–°–µ–∫—Ä–µ—Ç–Ω—ã–π_–ö–ª—é—á_AES'; // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–ª—é—á –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        let myNickname = '';
        let currentRecipient = null; // null = –û–±—â–∏–π —á–∞—Ç
        let lastUserList = [];

        // --- DOM —ç–ª–µ–º–µ–Ω—Ç—ã ---
        const regScreen = document.getElementById('registration-screen');
        const chatContainer = document.getElementById('chat-container');
        const nicknameInput = document.getElementById('nickname-input');
        const registerButton = document.getElementById('register-button');
        const regError = document.getElementById('registration-error');
        const usersList = document.getElementById('users-list');
        const messagesDiv = document.getElementById('messages');
        const inputForm = document.getElementById('input-form');
        const messageInput = document.getElementById('message-input');
        const chatHeader = document.getElementById('chat-header');
        const recipientIndicator = document.getElementById('recipient-indicator');
        const currentRecipientSpan = document.getElementById('current-recipient');
        const exitPrivateLink = document.getElementById('exit-private');

        // --- Crypto (–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ/–î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ) ---
        
        /** –®–∏—Ñ—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É —Å –ø–æ–º–æ—â—å—é AES */
        function encrypt(text) {
            try {
                const key = CryptoJS.enc.Utf8.parse(AES_KEY);
                const encrypted = CryptoJS.AES.encrypt(text, key, {
                    mode: CryptoJS.mode.ECB,
                    padding: CryptoJS.pad.Pkcs7
                });
                return encrypted.toString();
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:", e);
                return text;
            }
        }

        /** –î–µ—à–∏—Ñ—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É —Å –ø–æ–º–æ—â—å—é AES */
        function decrypt(encryptedText) {
            try {
                const key = CryptoJS.enc.Utf8.parse(AES_KEY);
                const decrypted = CryptoJS.AES.decrypt(encryptedText, key, {
                    mode: CryptoJS.mode.ECB,
                    padding: CryptoJS.pad.Pkcs7
                });
                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ:", e);
                return `[–ù–ï –ú–û–ñ–ï–¢ –ë–´–¢–¨ –î–ï–®–ò–§–†–û–í–ê–ù–û: ${encryptedText.substring(0, 30)}...]`;
            }
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ UI ---

        /** –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ —á–∞—Ç–∞ –≤–Ω–∏–∑ */
        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        /** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ UI */
        function addMessage(msg, isSelf = false, recipient = null) {
            const isSystem = msg.type === 'system';
            const isPrivate = msg.type === 'private';
            const messageDiv = document.createElement('div');
            
            let classes = ['message'];
            if (isSystem) {
                classes.push('system');
            } else if (isPrivate) {
                classes.push('private');
                if (isSelf) classes.push('self');
            } else {
                classes.push('public');
                if (isSelf) classes.push('self');
            }
            messageDiv.className = classes.join(' ');

            const content = isSystem ? msg.content : decrypt(msg.content);
            
            if (isSystem) {
                messageDiv.innerHTML = `<div class="message-content">${content}</div>`;
            } else {
                let senderText = isPrivate && isSelf ? `–í—ã (–¥–ª—è ${recipient})` : 
                                 isPrivate && !isSelf ? `üîí ${msg.sender} (–ü—Ä–∏–≤–∞—Ç–Ω–æ)` : 
                                 msg.sender;
                
                messageDiv.innerHTML = `
                    <div class="message-sender">${senderText}</div>
                    <div class="message-content">${content}</div>
                    <div class="message-time">${msg.timestamp}</div>
                `;
            }

            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        /** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        function updateUsersList(users) {
            lastUserList = users;
            usersList.innerHTML = '';
            
            const sortedUsers = users.sort((a, b) => {
                if (a === myNickname) return -1;
                if (b === myNickname) return 1;
                return a.localeCompare(b);
            });

            sortedUsers.forEach(user => {
                const li = document.createElement('li');
                li.textContent = user;
                if (user === myNickname) {
                    li.classList.add('me');
                } else {
                    li.onclick = () => startPrivateChat(user);
                }
                if (user === currentRecipient) {
                     li.classList.add('selected');
                }
                usersList.appendChild(li);
            });
        }
        
        /** –ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç */
        function startPrivateChat(recipient) {
            if (recipient === myNickname) return;
            currentRecipient = recipient;
            chatHeader.textContent = `–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –ß–∞—Ç —Å ${recipient}`;
            recipientIndicator.style.display = 'block';
            currentRecipientSpan.textContent = recipient;
            
            updateUsersList(lastUserList);
            messageInput.focus();
        }
        
        /** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –æ–±—â–∏–π —á–∞—Ç */
        function exitPrivateChat() {
            currentRecipient = null;
            chatHeader.textContent = '–û–±—â–∏–π –ß–∞—Ç (Default)';
            recipientIndicator.style.display = 'none';
            
            updateUsersList(lastUserList);
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π DOM ---

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        registerButton.onclick = () => {
            const nickname = nicknameInput.value.trim();
            if (nickname) {
                socket.emit('register', nickname);
            }
        };
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        inputForm.onsubmit = (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();

            if (messageText) {
                const encryptedContent = encrypt(messageText);

                if (currentRecipient) {
                    // –ü—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    socket.emit('private_message', {
                        recipientNickname: currentRecipient,
                        encryptedContent: encryptedContent
                    });
                } else {
                    // –û–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    socket.emit('public_message', encryptedContent);
                }
                
                messageInput.value = '';
                messageInput.style.height = '40px';
            }
        };
        
        // –°–±—Ä–æ—Å –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞
        exitPrivateLink.onclick = (e) => {
            e.preventDefault();
            exitPrivateChat();
        };

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto'; 
            this.style.height = (this.scrollHeight) + 'px';
            if (this.scrollHeight > 150) {
                this.style.height = '150px';
                this.style.overflowY = 'auto';
            } else {
                this.style.overflowY = 'hidden';
            }
        });

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Socket.io ---

        // –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        socket.on('registration_success', (nickname) => {
            myNickname = nickname;
            regScreen.style.display = 'none';
            chatContainer.style.display = 'flex';
            chatHeader.textContent = `–û–±—â–∏–π –ß–∞—Ç (–í–∞—à –Ω–∏–∫: ${myNickname})`;
            messageInput.focus();
        });

        // –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        socket.on('registration_error', (error) => {
            regError.textContent = error;
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        socket.on('user_list', (users) => {
            updateUsersList(users);
        });

        // –ü—Ä–∏–µ–º –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        socket.on('public_message', (msg) => {
            const isSelf = msg.sender === myNickname;
            addMessage(msg, isSelf);
        });

        // –ü—Ä–∏–µ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        socket.on('private_message', (msg) => {
            const isSelf = msg.sender === myNickname;
            const recipientNickname = msg.recipient;
            
            if (isSelf) {
                // –ï—Å–ª–∏ –º—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ –º—ã –≤ —ç—Ç–æ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ–º —á–∞—Ç–µ –∏–ª–∏ –≤ –æ–±—â–µ–º
                if (currentRecipient === recipientNickname || currentRecipient === null) {
                    addMessage(msg, true, recipientNickname);
                }
            } else {
                // –ï—Å–ª–∏ –º—ã –ø–æ–ª—É—á–∞—Ç–µ–ª—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ –º—ã –≤ —ç—Ç–æ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ–º —á–∞—Ç–µ –∏–ª–∏ –≤ –æ–±—â–µ–º
                if (currentRecipient === msg.sender || currentRecipient === null) {
                    addMessage(msg, false);
                } else {
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–∏–≥–∞—é—â–∏–π –∑–Ω–∞—á–æ–∫ –∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    console.log(`–ù–æ–≤–æ–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${msg.sender}`);
                }
            }
        });
        
    </script>
</body>
</html>
