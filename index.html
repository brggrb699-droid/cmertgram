<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CmertGram</title>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    
    <style>
        :root {
            --color-primary: #FFD700; /* –ó–æ–ª–æ—Ç–∏—Å—Ç–æ-–∂–µ–ª—Ç—ã–π (–ê–∫—Ü–µ–Ω—Ç) */
            --color-secondary: #007FFF; /* –Ø—Ä–∫–æ-—Å–∏–Ω–∏–π (–ö–Ω–æ–ø–∫–∏, –≤—ã–¥–µ–ª–µ–Ω–∏—è) */
            --color-background: #1e1e1e; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω —á–∞—Ç–∞ */
            --color-panel: #282c34; /* –§–æ–Ω –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏/–∫–∞—Ä—Ç–æ—á–µ–∫ */
            --color-nav: #23272f; /* –§–æ–Ω –≥–ª–∞–≤–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
            --color-text: #f0f0f0; /* –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç */
            --color-input: #3a3f4b; /* –§–æ–Ω –ø–æ–ª—è –≤–≤–æ–¥–∞ */
            --color-system: #7F7F7F;
            --color-public-bg: #444444; /* –§–æ–Ω –ø—É–±–ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–¥—Ä—É–≥–∏—Ö) */
            --color-my-message: #007FFF; /* –§–æ–Ω —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
            --color-private-bg: #007FFF40; 
            --color-nav-active: #3c414c;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ –°–µ—Ç–∫–∞ --- */
        #registration-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-background);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
        }
        
        #chat-container {
            display: none; 
            flex-grow: 1;
        }

        /* –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–°–µ—Ç–∫–∞ 3 –∫–æ–ª–æ–Ω–∫–∏: –ù–∞–≤–∏–≥–∞—Ü–∏—è | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ | –ß–∞—Ç) */
        #app-grid {
            display: grid;
            grid-template-columns: 80px 250px 1fr; /* –ù–∞–≤–∏–≥–∞—Ü–∏—è | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ | –ß–∞—Ç */
            height: 100%;
            width: 100%;
        }

        /* --- 1. –ì–ª–∞–≤–Ω–∞—è –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å (–°–ª–µ–≤–∞, –ø–æ —Ç–∏–ø—É Telegram) --- */
        #main-nav {
            background-color: var(--color-nav);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
            z-index: 50;
            position: relative;
        }

        #main-nav .nav-item {
            width: 100%;
            text-align: center;
            padding: 15px 0;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 20px; /* –ò–∫–æ–Ω–∫–∏ */
            color: var(--color-system);
        }

        #main-nav .nav-item:hover,
        #main-nav .nav-item.active {
            background-color: var(--color-nav-active);
            color: var(--color-primary);
        }

        /* --- 2. –ü–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/–†–∞–∑–¥–µ–ª–æ–≤ --- */
        #users-panel {
            background-color: var(--color-panel);
            border-right: 1px solid #333;
            overflow-y: auto;
            flex-shrink: 0;
            position: relative;
            z-index: 40;
        }

        #users-panel .header {
            padding: 15px;
            color: var(--color-primary);
            font-size: 1.1em;
            font-weight: bold;
            border-bottom: 1px solid #333;
        }

        #users-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #users-list li {
            padding: 10px 15px;
            margin: 0;
            cursor: pointer;
            transition: background-color 0.2s;
            border-left: 3px solid transparent;
        }

        #users-list li:hover {
            background-color: #3b3f49;
        }

        #users-list li.me {
            font-weight: bold;
            color: var(--color-primary);
            background-color: #3b3f49;
        }
        
        #users-list li.selected {
            background-color: var(--color-secondary);
            color: white;
            border-left: 3px solid var(--color-primary);
        }
        
        /* --- 3. –ü–∞–Ω–µ–ª—å –ß–∞—Ç–∞ --- */
        #main-chat {
            display: flex;
            flex-direction: column;
            background-color: var(--color-background);
            position: relative;
        }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —á–∞—Ç–∞ */
        #chat-top-header {
            background-color: var(--color-panel);
            border-bottom: 1px solid #333;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--color-primary);
        }
        
        #chat-controls button {
            background: var(--color-input);
            color: var(--color-text);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            margin-left: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #chat-controls button.active,
        #chat-controls button:hover {
            background-color: var(--color-secondary);
            color: white;
        }

        #chat-subtitle {
             padding: 5px 15px;
             font-size: 0.8em;
             color: var(--color-system);
        }

        #messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* --- –°–æ–æ–±—â–µ–Ω–∏—è (–∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ) --- */
        .message {
            max-width: 65%; /* –£–º–µ–Ω—å—à–∞–µ–º —à–∏—Ä–∏–Ω—É */
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            line-height: 1.4;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .message.public {
            background-color: var(--color-public-bg);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        /* –°–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message.public.self {
            background-color: var(--color-my-message);
            align-self: flex-end;
            color: white;
            border-bottom-right-radius: 5px;
        }

        /* –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö */
        .message.private {
            background-color: var(--color-private-bg);
            border: 1px solid var(--color-secondary);
            align-self: flex-start;
            position: relative;
            border-bottom-left-radius: 5px;
        }
        
        /* –°–≤–æ–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message.private.self {
            align-self: flex-end;
            background-color: var(--color-my-message);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message-sender {
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è, —á—Ç–æ–±—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—É */
        }

        .message-time {
            display: block;
            margin-top: 5px;
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.6);
            text-align: right;
        }

        /* --- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ (–ù–∏–∂–Ω—è—è) --- */
        #input-panel {
            background-color: var(--color-panel);
            border-top: 1px solid #333;
            padding: 10px 15px;
            display: flex;
            flex-direction: column;
        }

        #input-form {
            display: flex;
            padding: 5px 0;
        }

        #message-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 5px; 
            background-color: var(--color-input);
            color: var(--color-text); 
            font-size: 16px;
            resize: none;
            height: 40px;
            box-sizing: border-box;
        }

        #input-form button {
            margin-left: 10px;
            background-color: var(--color-secondary);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        /* --- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å --- */
        @media (max-width: 768px) {
            #app-grid {
                /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ì–ª–∞–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∏ –ü–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–Ω–∏–º–∞—é—Ç 100% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞, 
                   –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ "–∞–∫—Ç–∏–≤–Ω—ã" (–æ—Ç–∫—Ä—ã—Ç—ã) */
                grid-template-columns: 0 0 1fr;
            }

            #main-nav {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            #users-panel {
                position: fixed;
                left: 80px; /* –° —É—á–µ—Ç–æ–º —à–∏—Ä–∏–Ω—ã main-nav */
                top: 0;
                height: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            /* –ö–ª–∞—Å—Å—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–Ω–µ–ª–µ–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            #main-nav.active { transform: translateX(0); }
            #users-panel.active { transform: translateX(0); }

            #chat-top-header {
                padding-left: 50px; /* –ú–µ—Å—Ç–æ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é */
            }
            
            /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–º –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            #chat-controls {
                 display: none;
            }
            
            #menu-button-chat { /* –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é —á–∞—Ç–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç users-panel) */
                display: block;
                position: absolute;
                left: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: var(--color-primary);
                font-size: 24px;
                cursor: pointer;
            }

             #menu-button-nav { /* –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç main-nav) */
                display: block;
                position: absolute;
                left: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: var(--color-primary);
                font-size: 24px;
                cursor: pointer;
                z-index: 100; /* –í—ã—à–µ chat-top-header */
            }
        }
    </style>
</head>
<body>

    <div id="user-action-menu">
        <button onclick="startPrivateChat(this.dataset.user); hideActionMenu();">üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ</button>
        <button onclick="startCall(this.dataset.user); hideActionMenu();">üìû –ó–≤–æ–Ω–æ–∫ (–ó–∞–≥–ª—É—à–∫–∞)</button>
    </div>

    <div id="registration-screen">
        <h1>CmertGram</h1>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º:</p>
        <input type="text" id="nickname-input" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" maxlength="15">
        <button id="register-button">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
        <div id="registration-error"></div>
    </div>

    <div id="chat-container">
        <div id="app-grid">
            
            <div id="main-nav">
                <div class="nav-item active" id="nav-users" title="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏">üë§</div>
                <div class="nav-item" title="–ú–µ–Ω—é">‚ò∞</div>
                <div class="nav-item" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</div>
                </div>

            <div id="users-panel">
                <div class="header">Users panel</div>
                <ul id="users-list">
                    </ul>
                <button id="menu-button-nav" style="display: none;">‚ò∞</button>
            </div>

            <div id="main-chat">
                 <button id="menu-button-chat" style="display: none;">‚ò∞</button>
                <div id="chat-top-header">
                    <span id="chat-title">#chat Schat</span>
                    <div id="chat-controls">
                        <button class="active" data-mode="general">General</button>
                        <button data-mode="private" disabled>Private</button>
                    </div>
                </div>
                
                <div id="chat-subtitle">
                    #iponyene.sibtyltg.Talhana.Geneal@socket.s(1.0)...
                </div>
                
                <div id="messages">
                    </div>

                <div id="input-panel">
                    <div id="recipient-indicator" style="display: none;">
                        –í—ã –ø–∏—à–µ—Ç–µ: <span id="current-recipient"></span>. 
                        <a href="#" id="exit-private" style="color: var(--color-secondary); text-decoration: none;">[X] –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –û–±—â–∏–π</a>
                    </div>
                    <form id="input-form">
                        <textarea id="message-input" placeholder="#message-input" rows="1"></textarea>
                        <button type="submit">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        const socket = io({ transports: ['websocket'] });
        const AES_KEY = '–≠—Ç–æ_–û—á–µ–Ω—å_–°–µ–∫—Ä–µ—Ç–Ω—ã–π_–ö–ª—é—á_AES'; 
        let myNickname = '';
        let currentRecipient = null; 
        let lastUserList = [];

        // --- DOM —ç–ª–µ–º–µ–Ω—Ç—ã ---
        const regScreen = document.getElementById('registration-screen');
        const chatContainer = document.getElementById('chat-container');
        const usersPanel = document.getElementById('users-panel');
        const mainNav = document.getElementById('main-nav');
        const usersList = document.getElementById('users-list');
        const messagesDiv = document.getElementById('messages');
        const inputForm = document.getElementById('input-form');
        const messageInput = document.getElementById('message-input');
        const chatTitle = document.getElementById('chat-title');
        const recipientIndicator = document.getElementById('recipient-indicator');
        const currentRecipientSpan = document.getElementById('current-recipient');
        const exitPrivateLink = document.getElementById('exit-private');
        const actionMenu = document.getElementById('user-action-menu');
        const menuButtonChat = document.getElementById('menu-button-chat');
        const menuButtonNav = document.getElementById('menu-button-nav');
        
        // --- Crypto (–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ/–î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ) ---
        function encrypt(text) {
            try {
                const key = CryptoJS.enc.Utf8.parse(AES_KEY);
                const encrypted = CryptoJS.AES.encrypt(text, key, { mode: CryptoJS.mode.ECB, padding: CryptoJS.pad.Pkcs7 });
                return encrypted.toString();
            } catch (e) { return text; }
        }

        function decrypt(encryptedText) {
            try {
                const key = CryptoJS.enc.Utf8.parse(AES_KEY);
                const decrypted = CryptoJS.AES.decrypt(encryptedText, key, { mode: CryptoJS.mode.ECB, padding: CryptoJS.pad.Pkcs7 });
                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (e) { return `[–ù–ï –ú–û–ñ–ï–¢ –ë–´–¢–¨ –î–ï–®–ò–§–†–û–í–ê–ù–û: ${encryptedText.substring(0, 30)}...]`; }
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ UI ---
        
        function showUserActionMenu(user, event) {
            actionMenu.style.display = 'block'; 
            actionMenu.style.top = `${event.clientY}px`;
            
            const menuWidth = 200; 
            if (event.clientX + menuWidth > window.innerWidth) {
                 actionMenu.style.left = `${window.innerWidth - menuWidth - 10}px`;
            } else {
                 actionMenu.style.left = `${event.clientX}px`;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–Ω–æ–ø–æ–∫
            actionMenu.querySelector('button:nth-child(1)').dataset.user = user;
            actionMenu.querySelector('button:nth-child(2)').dataset.user = user;
            
            event.preventDefault(); 
        }

        function hideActionMenu() {
            actionMenu.style.display = 'none';
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addMessage(msg, isSelf = false, recipient = null) {
            const isSystem = msg.type === 'system';
            const isPrivate = msg.type === 'private';
            const messageDiv = document.createElement('div');
            
            let classes = ['message'];
            if (isSystem) {
                classes.push('system');
            } else if (isPrivate) {
                classes.push('private');
                if (isSelf) classes.push('self');
            } else {
                classes.push('public');
                if (isSelf) classes.push('self');
            }
            messageDiv.className = classes.join(' ');

            const content = isSystem ? msg.content : decrypt(msg.content);
            const time = msg.timestamp || new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            
            if (isSystem) {
                const formattedContent = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                messageDiv.innerHTML = `<div class="message-content">${formattedContent}</div>`;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">${content}</div>
                    <div class="message-time">${time}</div>
                `;
            }

            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        function updateUsersList(users) {
            lastUserList = users;
            usersList.innerHTML = '';
            
            const sortedUsers = users.sort((a, b) => {
                if (a === myNickname) return -1;
                if (b === myNickname) return 1;
                return a.localeCompare(b);
            });

            sortedUsers.forEach(user => {
                const li = document.createElement('li');
                li.textContent = user;
                if (user === myNickname) {
                    li.classList.add('me');
                } else {
                    li.oncontextmenu = (e) => showUserActionMenu(user, e); 
                    li.onclick = (e) => startPrivateChat(user);
                }
                if (user === currentRecipient) {
                     li.classList.add('selected');
                }
                usersList.appendChild(li);
            });
        }
        
        function startPrivateChat(recipient) {
            if (recipient === myNickname) return;
            currentRecipient = recipient;
            chatTitle.textContent = `#private ${recipient}`;
            recipientIndicator.style.display = 'block';
            currentRecipientSpan.textContent = recipient;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —Ä–µ–∂–∏–º–∞ —á–∞—Ç–∞
            document.querySelector('#chat-controls button[data-mode="general"]').classList.remove('active');
            document.querySelector('#chat-controls button[data-mode="private"]').classList.add('active');
            
            updateUsersList(lastUserList);
            messageInput.focus();
            
            // –°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            if (window.innerWidth <= 768) {
                usersPanel.classList.remove('active');
            }
        }
        
        function exitPrivateChat() {
            currentRecipient = null;
            chatTitle.textContent = `#chat Schat`;
            recipientIndicator.style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —Ä–µ–∂–∏–º–∞ —á–∞—Ç–∞
            document.querySelector('#chat-controls button[data-mode="general"]').classList.add('active');
            document.querySelector('#chat-controls button[data-mode="private"]').classList.remove('active');
            
            updateUsersList(lastUserList);
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π DOM ---

        document.getElementById('register-button').onclick = () => {
            const nickname = document.getElementById('nickname-input').value.trim();
            if (nickname) {
                socket.emit('register', nickname);
            }
        };
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        inputForm.onsubmit = (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();

            if (messageText) {
                const encryptedContent = encrypt(messageText);

                if (currentRecipient) {
                    socket.emit('private_message', {
                        recipientNickname: currentRecipient,
                        encryptedContent: encryptedContent
                    });
                } else {
                    socket.emit('public_message', encryptedContent);
                }
                
                messageInput.value = '';
                messageInput.style.height = '40px';
            }
        };
        
        // –°–±—Ä–æ—Å –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞
        exitPrivateLink.onclick = (e) => {
            e.preventDefault();
            exitPrivateChat();
        };

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ —á–∞—Ç–∞ (–∫–Ω–æ–ø–∫–∏ General/Private)
        document.getElementById('chat-controls').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const mode = e.target.dataset.mode;
                if (mode === 'general' && currentRecipient) {
                    exitPrivateChat();
                } 
                // Private mode –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ
            }
        });
        
        // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/–≥–ª–∞–≤–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        menuButtonChat.onclick = () => {
            usersPanel.classList.toggle('active');
            mainNav.classList.remove('active'); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        };
        
        menuButtonNav.onclick = () => {
            mainNav.classList.toggle('active');
            usersPanel.classList.remove('active'); // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        };


        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Socket.io ---

        socket.on('registration_success', (nickname) => {
            myNickname = nickname;
            regScreen.style.display = 'none';
            chatContainer.style.display = 'block'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º block –¥–ª—è —Å–µ—Ç–∫–∏
            chatTitle.textContent = `#chat Schat`;
            document.getElementById('chat-controls').querySelector('button[data-mode="general"]').classList.add('active');
            messageInput.focus();
        });

        socket.on('registration_error', (error) => {
            document.getElementById('registration-error').textContent = error;
        });

        socket.on('user_list', (users) => {
            updateUsersList(users);
        });

        socket.on('public_message', (msg) => {
            const isSelf = msg.sender === myNickname;
            addMessage(msg, isSelf);
        });

        socket.on('private_message', (msg) => {
            const isSelf = msg.sender === myNickname;
            const targetRecipient = isSelf ? msg.recipient : msg.sender;
            
            // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞ (–æ—Ç –º–µ–Ω—è –∏–ª–∏ –¥–ª—è –º–µ–Ω—è)
            if (currentRecipient === targetRecipient || currentRecipient === null) {
                 addMessage(msg, isSelf, targetRecipient);
            } 
            // –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ, —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            else {
                 console.log(`–ù–æ–≤–æ–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${msg.sender}.`);
                 // –ó–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –º–∏–≥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ
            }
        });
        
    </script>
</body>
</html>
