<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[INIT] NEON CYBER CONFERENCE v1.0.4</title>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script> 
    <style>
        /* [NEON_CYBER_STYLE] */
        :root {
            --bg-color: #111115;
            --main-neon: #33ccff; /* Neon Blue */
            --accent-neon: #ff66cc; /* Neon Pink */
            --font-color: #e0e0ff;
            --font-mono: 'Consolas', 'Monospace', monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--font-color);
            font-family: var(--font-mono);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .main-grid {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            border: 2px solid var(--main-neon);
            box-shadow: 0 0 15px var(--main-neon);
            padding: 15px;
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 20px;
            flex-grow: 1;
        }
        
        h3 {
            color: var(--accent-neon);
            text-shadow: 0 0 5px var(--accent-neon);
            border-bottom: 1px solid var(--accent-neon);
            padding-bottom: 5px;
            margin-top: 0;
        }

        /* --- NICKNAME FORM --- */
        #nick_form {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px dashed var(--main-neon);
            text-align: center;
        }

        /* --- VIDEO/CALLS SECTION --- */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
            min-height: 400px;
            border: 1px solid var(--main-neon);
            padding: 10px;
            background-color: #0d0d10;
        }
        
        .video-wrapper {
            position: relative;
            background-color: #1a1a20;
            border: 2px solid var(--accent-neon);
            box-sizing: border-box;
            aspect-ratio: 16 / 9; /* Стандартизация соотношения */
            overflow: hidden;
        }
        
        .video-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .video-label {
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--main-neon);
            padding: 4px 8px;
            font-size: 0.9em;
            border-bottom-right-radius: 5px;
            text-shadow: 0 0 2px var(--main-neon);
        }

        /* --- CHAT SECTION --- */
        .right-panel {
            display: flex;
            flex-direction: column;
        }

        .chat-box {
            height: 70vh; /* Увеличение высоты чата */
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid var(--accent-neon);
            background-color: #0d0d10;
            flex-grow: 1;
        }

        /* --- MESSAGE STYLES --- */
        .system-message { 
            color: #ffaa00; /* Yellow */
            font-weight: bold; 
        }
        .user-message {
            margin: 5px 0;
            word-wrap: break-word;
        }
        .user-message strong { 
            color: var(--main-neon); 
            margin-right: 5px; 
        }

        /* --- INPUTS & BUTTONS --- */
        input[type="text"], button {
            background-color: #222225;
            color: var(--font-color);
            border: 1px solid var(--main-neon);
            padding: 10px;
            font-family: inherit;
            box-shadow: 0 0 5px rgba(51, 204, 255, 0.5);
            transition: all 0.2s;
        }
        
        button:hover:not(:disabled) {
            background-color: var(--main-neon);
            color: var(--bg-color);
            cursor: pointer;
            box-shadow: 0 0 15px var(--main-neon);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .message-input { 
            display: flex; 
            margin-top: auto; /* Прижимаем ко дну */
        }
        .message-input input { 
            flex-grow: 1; 
            margin-right: 5px; 
        }
        
        .call-controls button {
            margin-right: 10px;
            margin-top: 10px;
            border-color: var(--accent-neon);
            box-shadow: 0 0 5px rgba(255, 102, 204, 0.5);
        }
    </style>
</head>
<body>

    <div class="main-grid">
        
        <div class="left-panel">
            <h3 id="conference_status">[NEON_CYBER_CORE] STATUS: OFFLINE</h3>

            <div class="form-group" id="nick_form">
                <input type="text" id="nickname_input" placeholder=">>> ВВЕДИ СВОЙ НИК/CALLSIGN" required>
                <button onclick="saveNickname()">[АКТИВИРОВАТЬ КОНФЕРЕНЦИЮ]</button>
            </div>
            
            <div class="call-controls" style="display: none;" id="controls_block">
                <h3>[МЕДИА-КОНТРОЛЛЕР]</h3>
                <button id="hangupButton" onclick="hangUp()">[ОТКЛЮЧИТЬ ВСЕ]</button>
                <button id="audioToggle" onclick="toggleAudio()">[ВЫКЛ. МИКР.]</button>
                <button id="videoToggle" onclick="toggleVideo()">[ВЫКЛ. ВИДЕО]</button>
            </div>
            
            <div class="video-grid" id="video_grid">
                </div>
        </div>

        <div class="right-panel">
            <h3>[ГЛОБАЛЬНЫЙ ТЕКСТ-ЧАТ (SMS)]</h3>
            <div class="chat-box" id="chat_box">
                </div>

            <div class="message-input">
                <input type="text" id="message_input" placeholder=">>> СООБЩЕНИЕ (Enter для отправки)" onkeydown="if(event.keyCode===13) sendMessage()" disabled>
                <button onclick="sendMessage()" id="send_button" disabled>[ПЕРЕДАТЬ]</button>
            </div>
        </div>
    </div>

    <script>
        // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
        let ws;
        let peerId; 
        let nickname;
        let localStream;
        const peers = new Map(); // { peerId: simple-peer_instance }
        let allUsers = new Map(); // { peerId: { id, nickname } }

        // ЭЛЕМЕНТЫ DOM
        const chatBox = document.getElementById('chat_box');
        const messageInput = document.getElementById('message_input');
        const sendButton = document.getElementById('send_button');
        const nicknameInput = document.getElementById('nickname_input');
        const nickForm = document.getElementById('nick_form');
        const controlsBlock = document.getElementById('controls_block');
        const conferenceStatus = document.getElementById('conference_status');
        const videoGrid = document.getElementById('video_grid');
        const hangupButton = document.getElementById('hangupButton');
        const audioToggle = document.getElementById('audioToggle');
        const videoToggle = document.getElementById('videoToggle');

        // [INIT] ГЕНЕРАЦИЯ УНИКАЛЬНОГО ID И WEB SOCKET
        peerId = 'PEER_' + Math.random().toString(36).substring(2, 9).toUpperCase();
        
        function initWebSocket() {
            conferenceStatus.innerHTML = `[NEON_CYBER_CORE] STATUS: CONNECTING... (PEER: ${peerId})`;
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Используем host (localhost:3000 или домен)
            ws = new WebSocket(`${protocol}//${window.location.host}`); 

            ws.onopen = function() {
                conferenceStatus.innerHTML = `[NEON_CYBER_CORE] STATUS: WAITING FOR CALLSIGN. (PEER: ${peerId})`;
                displayMessage({ type: 'SYSTEM', message: 'СОЕДИНЕНИЕ УСТАНОВЛЕНО. ВВЕДИТЕ НИК ДЛЯ АКТИВАЦИИ СИСТЕМ.' });
                
                // Автозаполнение ника, если есть в localStorage
                const savedNick = localStorage.getItem('nickname');
                if (savedNick) {
                    nicknameInput.value = savedNick;
                }
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleIncomingMessage(data);
                } catch (e) {
                    displayMessage({ type: 'ERROR', message: 'ОШИБКА ДАННЫХ: INCOMING DATA CORRUPTED.' });
                }
            };
            
            ws.onclose = function() {
                conferenceStatus.innerHTML = `[NEON_CYBER_CORE] STATUS: OFFLINE. (PEER: ${peerId})`;
                hangUp(false); // Очищаем интерфейс
                displayMessage({ type: 'SYSTEM', message: 'СВЯЗЬ ПОТЕРЯНА. RESTARTING PROTOCOLS...' });
                messageInput.disabled = true;
                sendButton.disabled = true;
                nickForm.style.display = 'block';
                controlsBlock.style.display = 'none';
            };
        }

        // [NICKNAME_HANDLER] Сохранение ника, запуск медиа и регистрация
        async function saveNickname() {
            const nick = nicknameInput.value.trim().toUpperCase();

            if (nick.length < 2) {
                alert("NICKNAME_ERROR: МИНИМУМ 2 СИМВОЛА");
                return;
            }

            nickname = nick;
            localStorage.setItem('nickname', nickname);
            
            // 1. Скрытие формы и активация контролов
            nickForm.style.display = 'none';
            controlsBlock.style.display = 'block';
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
            
            conferenceStatus.innerHTML = `[NEON_CYBER_CORE] STATUS: ONLINE | CALLSIGN: ${nickname}`;
            
            // 2. Получение локального потока (АУДИО + ВИДЕО)
            try {
                await initLocalMedia();
            } catch (e) {
                displayMessage({ type: 'ERROR', message: `МЕДИА-ОШИБКА: ${e.name}. ГОЛОС/ВИДЕО НЕДОСТУПНЫ.` });
            }
            
            // 3. Регистрация в глобальном чате (запуск Mesh-протокола)
            if (ws.readyState === WebSocket.OPEN) {
                 ws.send(JSON.stringify({
                    type: 'REGISTER',
                    peerId: peerId,
                    sender: nickname
                }));
                displayMessage({ type: 'SYSTEM', message: `СИСТЕМА АКТИВИРОВАНА. CALLSIGN: ${nickname}. УСТАНОВКА P2P СОЕДИНЕНИЙ...` });
            }
        }
        
        // [MEDIA] Инициализация локального потока
        async function initLocalMedia() {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            
            // Создание элемента для локального видео
            const localWrapper = createVideoWrapper(peerId, nickname + ' (ТЫ)');
            const localVideo = localWrapper.querySelector('video');
            localVideo.muted = true; // Отключаем звук для своего видео
            localVideo.srcObject = localStream;
            videoGrid.prepend(localWrapper); // Свой поток всегда первый
            
            // Активация контролов
            hangupButton.disabled = false;
            audioToggle.disabled = false;
            videoToggle.disabled = false;
        }

        // [WS_RECEIVE] Обработка входящих WS-сообщений
        function handleIncomingMessage(data) {
            switch (data.type) {
                case 'SYSTEM':
                case 'CHAT_MESSAGE':
                    displayMessage(data);
                    break;
                case 'USER_LIST_UPDATE':
                    updateUserList(data.users);
                    break;
                case 'USER_LEFT':
                    removePeer(data.leftId);
                    displayMessage({ type: 'SYSTEM', message: `ПОЛЬЗОВАТЕЛЬ ОТКЛЮЧИЛСЯ: ${allUsers.get(data.leftId)?.nickname || data.leftId}` });
                    allUsers.delete(data.leftId); // Удаляем из списка
                    break;
                case 'WEBRTC_SIGNAL':
                    handleSignal(data.senderId, data.signal);
                    break;
            }
        }

        // [USER_LIST] Обновление списка активных пользователей и синхронизация P2P
        function updateUserList(users) {
            const newUsersMap = new Map();
            users.forEach(u => newUsersMap.set(u.id, u));
            
            // 1. Обработка ушедших (удаление старых соединений)
            for (const id of allUsers.keys()) {
                if (!newUsersMap.has(id) && id !== peerId) {
                    removePeer(id);
                }
            }
            
            // 2. Обработка новых (создание новых соединений)
            for (const [id, user] of newUsersMap.entries()) {
                if (id !== peerId && !peers.has(id)) {
                    // Используем ID для детерминированного выбора инициатора
                    const initiator = peerId < id; 
                    if (localStream) {
                        createPeer(id, user.nickname, initiator);
                    }
                }
            }
            
            allUsers = newUsersMap;
        }

        // [PEER_MANAGER] Создание нового P2P соединения (Голос/Видео)
        function createPeer(targetId, targetNickname, initiator) {
            if (peers.has(targetId)) return;

            const newPeer = new SimplePeer({
                initiator: initiator,
                trickle: true, 
                stream: localStream
            });

            peers.set(targetId, newPeer);

            newPeer.on('signal', data => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'WEBRTC_SIGNAL',
                        senderId: peerId,
                        targetId: targetId,
                        signal: data
                    }));
                }
            });

            newPeer.on('stream', stream => {
                // Прием удаленного потока (Аудио и Видео)
                addRemoteStream(targetId, targetNickname, stream);
                displayMessage({ 
                    type: 'SYSTEM', 
                    message: `СВЯЗЬ УСТАНОВЛЕНА: ${targetNickname}. (ГОЛОС/ВИДЕО АКТИВНЫ)` 
                });
            });

            newPeer.on('close', () => {
                removePeer(targetId, true);
                displayMessage({ 
                    type: 'SYSTEM', 
                    message: `СВЯЗЬ ПРЕРВАНА: ${targetNickname}` 
                });
            });

            newPeer.on('error', (err) => {
                console.error(`P2P Error with ${targetId}:`, err);
                removePeer(targetId, true);
            });
        }
        
        // [PEER_MANAGER] Обработка входящего сигнала
        function handleSignal(senderId, signal) {
            if (senderId === peerId) return;

            if (peers.has(senderId)) {
                peers.get(senderId).signal(signal);
                return;
            }

            if (signal.type === 'offer' || !signal.type) { 
                const senderInfo = allUsers.get(senderId);
                const senderNickname = senderInfo ? senderInfo.nickname : 'НЕИЗВЕСТНО';
                
                if (localStream) {
                    // Создаем peer-ответчик
                    createPeer(senderId, senderNickname, false); 
                    peers.get(senderId).signal(signal);
                }
            }
        }

        // [PEER_MANAGER] Удаление P2P соединения и DOM-элемента
        function removePeer(targetId, destroy = false) {
            const remoteWrapper = document.getElementById(`video-${targetId}`);
            if (remoteWrapper) {
                remoteWrapper.remove();
            }
            if (peers.has(targetId)) {
                if (destroy) peers.get(targetId).destroy();
                peers.delete(targetId);
            }
        }
        
        // [DOM_MANIPULATION] Добавление удаленного стрима в DOM
        function addRemoteStream(id, nickname, stream) {
            let wrapper = document.getElementById(`video-${id}`);
            if (!wrapper) {
                wrapper = createVideoWrapper(id, nickname);
                videoGrid.appendChild(wrapper);
            }
            wrapper.querySelector('video').srcObject = stream;
        }
        
        // [DOM_MANIPULATION] Создание обертки для видео
        function createVideoWrapper(id, label) {
            const wrapper = document.createElement('div');
            wrapper.className = 'video-wrapper';
            wrapper.id = `video-${id}`;
            
            const video = document.createElement('video');
            video.autoplay = true;
            
            const labelEl = document.createElement('div');
            labelEl.className = 'video-label';
            labelEl.textContent = `[ПИР] ${label}`;
            
            wrapper.appendChild(video);
            wrapper.appendChild(labelEl);
            return wrapper;
        }

        // [CHAT] Отправка сообщения
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || ws.readyState !== WebSocket.OPEN) return;

            const message_data = {
                type: 'CHAT_MESSAGE',
                sender: nickname,
                message: message
            };

            ws.send(JSON.stringify(message_data));
            messageInput.value = '';
        }

        function displayMessage(data) {
            const messageElement = document.createElement('p');
            
            if (data.type === 'SYSTEM' || data.type === 'ERROR') {
                messageElement.className = 'system-message';
                messageElement.innerHTML = `[СИСТЕМА] ${data.message}`;
            } else {
                messageElement.className = 'user-message';
                messageElement.innerHTML = `<strong>[${data.sender}]</strong> > ${data.message}`;
            }
            
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // [HANGUP] Завершение всех соединений
        function hangUp(do_disconnect = true) {
            // Уничтожение всех P2P соединений
            for (const peer of peers.values()) {
                peer.destroy();
            }
            peers.clear();
            
            // Остановка локального потока
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Очистка DOM, кроме элемента формы
            videoGrid.innerHTML = ''; 
            
            if (do_disconnect && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            
            // Сброс UI
            hangupButton.disabled = true;
            audioToggle.disabled = true;
            videoToggle.disabled = true;
            audioToggle.textContent = '[ВЫКЛ. МИКР.]';
            videoToggle.textContent = '[ВЫКЛ. ВИДЕО]';
            
            if (do_disconnect) {
                // Если был ручной сброс, UI перейдет в режим "Disconnected" через ws.onclose
            }
        }
        
        // [CONTROLS] Переключение аудио
        function toggleAudio() {
            if (!localStream) return;
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                audioToggle.textContent = audioTrack.enabled ? '[ВЫКЛ. МИКР.]' : '[ВКЛ. МИКР.]';
                displayMessage({ type: 'SYSTEM', message: audioTrack.enabled ? 'АУДИО ВКЛЮЧЕНО' : 'АУДИО ОТКЛЮЧЕНО' });
            }
        }

        // [CONTROLS] Переключение видео
        function toggleVideo() {
            if (!localStream) return;
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                videoToggle.textContent = videoTrack.enabled ? '[ВЫКЛ. ВИДЕО]' : '[ВКЛ. ВИДЕО]';
                displayMessage({ type: 'SYSTEM', message: videoTrack.enabled ? 'ВИДЕО ВКЛЮЧЕНО' : 'ВИДЕО ОТКЛЮЧЕНО' });
            }
        }

        // АВТОЗАПУСК
        document.addEventListener('DOMContentLoaded', initWebSocket);
    </script>
</body>
</html>
