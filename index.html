<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CmertGramm</title>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        :root {
            --tg-blue: #0088CC; 
            --tg-dark: #1F2C3D; 
            --tg-bg: #1A2433; 
            --tg-text: #E0E0E0; 
            --tg-accent: #65A30D; 
            --tg-message-self: #4A9C4A; 
            --tg-message-other: #334455; 
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
        #registration-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: var(--tg-bg); display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 1000; text-align: center;
        }
        #registration-screen input, #registration-screen button {
            padding: 10px; border-radius: 5px; font-size: 16px; margin: 5px; width: 80%; max-width: 300px;
        }
        #registration-screen input { background-color: var(--tg-dark); border: 1px solid #333; color: var(--tg-text); }
        #registration-screen button { background-color: var(--tg-blue); color: white; border: none; cursor: pointer; }
        
        /* –°–µ—Ç–∫–∞ —á–∞—Ç–∞ */
        #chat-container { display: none; flex-grow: 1; width: 100%; }
        #chat-list-panel { 
            width: 350px; min-width: 250px; background-color: var(--tg-dark); border-right: 1px solid #333; 
            overflow-y: auto; flex-shrink: 0; position: relative;
        }
        #main-chat { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--tg-bg); }
        #chat-list li { padding: 15px; border-bottom: 1px solid #29384B; cursor: pointer; }
        #chat-list li.active { background-color: var(--tg-blue); color: white; }
        #chat-header { 
            padding: 15px; background-color: var(--tg-dark); border-bottom: 1px solid #333; font-size: 1.1em; 
            font-weight: bold; display: flex; justify-content: space-between; align-items: center;
        }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        #messages { flex-grow: 1; padding: 10px 15px; overflow-y: auto; display: flex; flex-direction: column; }
        .message { max-width: 60%; margin-bottom: 8px; padding: 8px 12px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; font-size: 0.95em; }
        .message.self { background-color: var(--tg-message-self); align-self: flex-end; color: white; border-bottom-right-radius: 4px; }
        .message.other { background-color: var(--tg-message-other); align-self: flex-start; color: var(--tg-text); border-bottom-left-radius: 4px; }
        .message.system { align-self: center; background-color: transparent; color: var(--tg-accent); font-size: 0.8em; padding: 5px; }
        .message-time { display: block; margin-top: 3px; font-size: 0.7em; color: rgba(255, 255, 255, 0.6); text-align: right; }
        
        /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ */
        #input-form { display: flex; padding: 10px 15px; background-color: var(--tg-dark); border-top: 1px solid #333; }
        #message-input { 
            flex-grow: 1; padding: 10px; border: none; border-radius: 20px; background-color: #334455; 
            color: var(--tg-text); font-size: 16px; resize: none; height: 40px; box-sizing: border-box; line-height: 20px;
        }
        #input-form button { 
            margin-left: 10px; background-color: var(--tg-blue); color: white; padding: 10px 15px; 
            border: none; border-radius: 20px; cursor: pointer; font-size: 16px;
        }
        
        /* --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ó–≤–æ–Ω–∫–∞ (WebRTC View) --- */
        #call-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.9); z-index: 2000; justify-content: center; 
            align-items: center; flex-direction: column; color: white;
        }
        #call-video-container {
            position: relative; width: 80%; max-width: 900px; height: 60%; background-color: #111; 
            border-radius: 10px; overflow: hidden; margin-bottom: 20px;
        }
        #local-video {
            position: absolute; top: 10px; right: 10px; width: 150px; height: 100px; 
            background-color: #333; border: 2px solid white; border-radius: 5px; z-index: 10;
            object-fit: cover; /* –í–∞–∂–Ω–æ –¥–ª—è –≤–∏–¥–µ–æ */
        }
        #remote-video { width: 100%; height: 100%; background-color: #222; object-fit: cover; }
        #call-controls button.red { background-color: #D9534F; }
        
        /* –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–¥–∏–∞ */
        #call-controls button.disabled {
            background-color: #555 !important;
            color: #ccc;
        }
        
        #call-controls button {
            background-color: var(--tg-blue); color: white; border: none; padding: 15px 20px; 
            border-radius: 50%; margin: 10px; cursor: pointer; font-size: 1.2em;
            transition: background-color 0.2s;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-width: 800px) {
            #chat-list-panel { 
                width: 100%; position: fixed; height: 100%; z-index: 10; 
                /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å active */
                transform: translateX(-100%); transition: transform 0.3s ease-in-out; 
            }
            #chat-list-panel.active { transform: translateX(0); }
            
            /* –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
            .menu-toggle { 
                display: block !important; background: none; border: none; color: var(--tg-text); 
                font-size: 24px; cursor: pointer; padding: 0 10px 0 0; 
            }
            
            /* –°–∫—Ä—ã—Ç–∏–µ –Ω–∞ PC */
            .menu-toggle-pc { display: none; }
        }
        .menu-toggle { display: none; }
    </style>
</head>
<body>

    <div id="registration-screen">
        <h1>CmertGramm</h1>
        <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º –¥–ª—è –≤—Ö–æ–¥–∞:</p>
        <input type="text" id="nickname-input" placeholder="–ù–∏–∫–Ω–µ–π–º" maxlength="15">
        <button id="register-button">–í–æ–π—Ç–∏</button>
        <div id="registration-error" style="color: red; margin-top: 10px;"></div>
    </div>

    <div id="chat-container">
        
        <div id="chat-list-panel">
            <h3>üë• –ß–∞—Ç—ã</h3>
            <ul id="chat-list">
                <li id="general-chat-item" class="active" data-recipient="–æ–±—â–µ–µ">–û–±—â–∏–π –ß–∞—Ç</li>
            </ul>
        </div>

        <div id="main-chat">
            <div id="chat-header">
                <button class="menu-toggle" id="menu-toggle-btn">‚ò∞</button>
                <span id="current-chat-title">–û–±—â–∏–π –ß–∞—Ç</span>
                <span style="font-size: 0.8em; color: var(--tg-accent);">Online</span> 
            </div>
            
            <div id="messages"></div>

            <form id="input-form">
                <textarea id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <div id="call-modal">
        <h2 id="call-status"></h2>
        <p id="call-partner"></p>

        <div id="call-video-container">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay muted playsinline></video>
        </div>

        <div id="call-controls">
            <button id="toggle-video" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ">üìπ</button>
            <button id="toggle-audio" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω">üéôÔ∏è</button>
            <button id="end-call-btn" class="red" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫">üìû</button>
        </div>
    </div>

    <script>
        // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ WebRTC/–°–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ ---
        let localStream;
        let peerConnection;
        let isCalling = false;
        let currentCallTarget = null;
        let isVideoOn = true;
        let isAudioOn = true;
        
        const STUN_SERVERS = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }, 
            ]
        };
        
        // --- –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        const socket = io({ transports: ['websocket'] });
        let myNickname = '';
        let currentRecipient = '–æ–±—â–µ–µ'; 
        let allUsers = []; 
        const messageStore = { '–æ–±—â–µ–µ': [] };

        // --- DOM —ç–ª–µ–º–µ–Ω—Ç—ã ---
        const regScreen = document.getElementById('registration-screen');
        const chatContainer = document.getElementById('chat-container');
        const nicknameInput = document.getElementById('nickname-input');
        const registerButton = document.getElementById('register-button');
        const regError = document.getElementById('registration-error');
        const chatListPanel = document.getElementById('chat-list-panel');
        const chatList = document.getElementById('chat-list');
        const messagesDiv = document.getElementById('messages');
        const inputForm = document.getElementById('input-form');
        const messageInput = document.getElementById('message-input');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã WebRTC
        const callModal = document.getElementById('call-modal');
        const callStatus = document.getElementById('call-status');
        const callPartner = document.getElementById('call-partner');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const endCallBtn = document.getElementById('end-call-btn');
        const toggleVideoBtn = document.getElementById('toggle-video');
        const toggleAudioBtn = document.getElementById('toggle-audio');


        // --- –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò UI ---
        
        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addMessageToStore(recipient, msg) {
            if (!messageStore[recipient]) {
                messageStore[recipient] = [];
            }
            messageStore[recipient].push(msg);
        }

        function displayMessage(msg) {
            const isSystem = msg.type === 'system';
            const messageDiv = document.createElement('div');
            
            let classes = ['message'];
            if (isSystem) {
                classes.push('system');
            } else if (msg.sender === myNickname) {
                classes.push('self');
            } else {
                classes.push('other');
            }
            messageDiv.className = classes.join(' ');

            const time = msg.timestamp || new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            
            if (isSystem) {
                messageDiv.innerHTML = `<span>${msg.content}</span>`;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">${msg.content}</div>
                    <div class="message-time">${time}</div>
                `;
            }

            messagesDiv.appendChild(messageDiv);
        }
        
        function loadChat(recipient) {
            currentRecipient = recipient;
            messagesDiv.innerHTML = '';
            
            const headerContent = document.getElementById('chat-header');
            
            if (recipient === '–æ–±—â–µ–µ') {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–ª—è –æ–±—â–µ–≥–æ —á–∞—Ç–∞ (–Ω–µ—Ç –∫–Ω–æ–ø–∫–∏ –∑–≤–æ–Ω–∫–∞)
                headerContent.innerHTML = `
                    <button class="menu-toggle" id="menu-toggle-btn">‚ò∞</button>
                    <span id="current-chat-title">–û–±—â–∏–π –ß–∞—Ç</span>
                    <span style="font-size: 0.8em; color: var(--tg-accent);">Online</span>
                `;
            } else {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ (–µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ –∑–≤–æ–Ω–∫–∞)
                headerContent.innerHTML = `
                    <button class="menu-toggle" id="menu-toggle-btn">‚ò∞</button>
                    <span id="current-chat-title">–ß–∞—Ç —Å ${recipient}</span>
                    <button id="initiate-call-btn" style="background: none; border: none; color: var(--tg-accent); cursor: pointer; font-size: 1.5em; padding: 0;" title="–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫">üìû</button>
                `;
                // –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —Ç–∞–∫ –∫–∞–∫ HTML –±—ã–ª –ø–µ—Ä–µ–ø–∏—Å–∞–Ω
                document.getElementById('initiate-call-btn').onclick = initiateCall;
            }
            
            document.getElementById('menu-toggle-btn').onclick = () => chatListPanel.classList.toggle('active');

            document.getElementById('current-chat-title').textContent = recipient === '–æ–±—â–µ–µ' ? '–û–±—â–∏–π –ß–∞—Ç' : `–ß–∞—Ç —Å ${recipient}`;

            document.querySelectorAll('#chat-list li').forEach(li => {
                li.classList.remove('active');
                if (li.dataset.recipient === recipient) {
                    li.classList.add('active');
                }
            });

            const messages = messageStore[recipient] || [];
            messages.forEach(displayMessage);
            scrollToBottom();
            
            if (window.innerWidth <= 800) {
                chatListPanel.classList.remove('active');
            }
            messageInput.focus();
        }

        function updateChatList(users) {
            allUsers = users;
            chatList.innerHTML = '';

            const generalLi = document.createElement('li');
            generalLi.textContent = '–û–±—â–∏–π –ß–∞—Ç';
            generalLi.dataset.recipient = '–æ–±—â–µ–µ';
            generalLi.onclick = () => loadChat('–æ–±—â–µ–µ');
            if (currentRecipient === '–æ–±—â–µ–µ') generalLi.classList.add('active');
            chatList.appendChild(generalLi);
            
            users.filter(user => user !== myNickname).forEach(user => {
                const li = document.createElement('li');
                li.textContent = user;
                li.dataset.recipient = user;
                if (!messageStore[user]) messageStore[user] = [];
                li.onclick = () => loadChat(user);
                if (currentRecipient === user) li.classList.add('active');
                chatList.appendChild(li);
            });
            
            if (currentRecipient !== '–æ–±—â–µ–µ' && !users.includes(currentRecipient)) {
                 loadChat('–æ–±—â–µ–µ');
            }
        }
        
        // --- –§–£–ù–ö–¶–ò–ò WEBRTC ---
        
        async function getLocalMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞
                isVideoOn = true;
                isAudioOn = true;
                toggleVideoBtn.classList.remove('disabled');
                toggleAudioBtn.classList.remove('disabled');
                toggleVideoBtn.textContent = 'üìπ';
                toggleAudioBtn.textContent = 'üéôÔ∏è';

                return true;
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –º–µ–¥–∏–∞-–¥–æ—Å—Ç—É–ø–∞:", err);
                alert("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.");
                return false;
            }
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(STUN_SERVERS);
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫–∞
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('webrtc_ice', {
                        target: currentCallTarget,
                        candidate: event.candidate,
                    });
                }
            };
            
            return peerConnection;
        }

        async function sendOffer() {
            peerConnection = createPeerConnection();
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            socket.emit('webrtc_offer', {
                target: currentCallTarget,
                sdp: peerConnection.localDescription,
            });
        }

        async function handleOffer(offerSdp) {
            peerConnection = createPeerConnection();
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offerSdp));
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            socket.emit('webrtc_answer', {
                target: currentCallTarget,
                sdp: peerConnection.localDescription,
            });
        }
        
        async function handleAnswer(answerSdp) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answerSdp));
        }
        
        function stopWebRTC() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
        }

        // --- –§–£–ù–ö–¶–ò–ò –ó–í–û–ù–ö–ê (UI/–õ–û–ì–ò–ö–ê) ---

        async function initiateCall() {
            if (currentRecipient === '–æ–±—â–µ–µ' || isCalling) return;
            
            if (!(await getLocalMedia())) return;

            isCalling = true;
            currentCallTarget = currentRecipient;

            callStatus.textContent = '–ò–¥–µ—Ç –≤—ã–∑–æ–≤...';
            callPartner.textContent = `–ó–≤–æ–Ω–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: ${currentCallTarget}`;
            callModal.style.display = 'flex';
            
            await sendOffer();
        }

        async function answerCall(offerSdp) {
            if (!(await getLocalMedia())) return;
            
            isCalling = true;
            await handleOffer(offerSdp);
            
            callStatus.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!';
            callPartner.textContent = `–í—ã –≤ —á–∞—Ç–µ —Å ${currentCallTarget}`;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            document.getElementById('call-controls').innerHTML = `
                <button id="toggle-video" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ">üìπ</button>
                <button id="toggle-audio" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω">üéôÔ∏è</button>
                <button id="end-call-btn" class="red" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫">üìû</button>
            `;
            // –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è DOM
            document.getElementById('toggle-video').onclick = toggleVideoBtnHandler;
            document.getElementById('toggle-audio').onclick = toggleAudioBtnHandler;
            document.getElementById('end-call-btn').onclick = endCall;

            addMessageToStore(currentCallTarget, { type: 'system', content: `üìû –ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞—Ç.` });
            loadChat(currentCallTarget);
        }
        
        function endCall() {
            if (!isCalling) return;

            socket.emit('call_end', currentCallTarget);
            
            stopWebRTC(); 
            
            callStatus.textContent = '–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω.';
            addMessageToStore(currentRecipient, { type: 'system', content: `üìû –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω.` });
            loadChat(currentRecipient);

            setTimeout(() => {
                callModal.style.display = 'none';
                isCalling = false;
                currentCallTarget = null;
            }, 1500);
        }

        // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö –ú–ï–î–ò–ê (–ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ) ---
        
        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ/–≤–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–µ–æ
        const toggleVideoBtnHandler = () => {
            if (!localStream) return;
            
            isVideoOn = !isVideoOn;
            localStream.getVideoTracks().forEach(track => track.enabled = isVideoOn);
            
            toggleVideoBtn.textContent = isVideoOn ? 'üìπ' : '‚¨õ';
            toggleVideoBtn.classList.toggle('disabled', !isVideoOn);
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä—É –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —Å–ª–æ–∂–Ω–æ–≥–æ UI)
        };
        toggleVideoBtn.onclick = toggleVideoBtnHandler;

        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ/–≤–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        const toggleAudioBtnHandler = () => {
            if (!localStream) return;
            
            isAudioOn = !isAudioOn;
            localStream.getAudioTracks().forEach(track => track.enabled = isAudioOn);
            
            toggleAudioBtn.textContent = isAudioOn ? 'üéôÔ∏è' : 'üîá';
            toggleAudioBtn.classList.toggle('disabled', !isAudioOn);
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä—É –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        };
        toggleAudioBtn.onclick = toggleAudioBtnHandler;
        
        endCallBtn.onclick = endCall;


        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ DOM (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥) ---

        registerButton.onclick = () => {
            const nickname = nicknameInput.value.trim();
            if (nickname) {
                socket.emit('register', nickname);
            }
        };
        
        inputForm.onsubmit = (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();

            if (messageText) {
                const msg = {
                    sender: myNickname,
                    content: messageText,
                    timestamp: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
                };

                if (currentRecipient === '–æ–±—â–µ–µ') {
                    socket.emit('public_message', msg);
                } else {
                    msg.recipient = currentRecipient;
                    socket.emit('private_message', msg);
                }
                
                addMessageToStore(currentRecipient, msg);
                loadChat(currentRecipient);
                
                messageInput.value = '';
                messageInput.style.height = '40px';
            }
        };
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤ loadChat, –Ω–æ —Ç–∞–∫–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–¥–µ—Å—å)
        if (menuToggleBtn) {
            menuToggleBtn.onclick = () => chatListPanel.classList.toggle('active');
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Socket.io (–°–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è) ---

        socket.on('registration_success', (nickname) => {
            myNickname = nickname;
            
            regScreen.style.display = 'none';
            chatContainer.style.display = 'flex';
            
            loadChat('–æ–±—â–µ–µ'); 
            
            addMessageToStore('–æ–±—â–µ–µ', { type: 'system', content: `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ WebGram, ${nickname}!` });
            loadChat('–æ–±—â–µ–µ');
        });

        socket.on('registration_error', (error) => {
            regError.textContent = error;
        });

        socket.on('user_list', (users) => {
            updateChatList(users);
        });
        
        socket.on('public_message', (msg) => {
            if (msg.sender !== myNickname) {
                addMessageToStore('–æ–±—â–µ–µ', msg);
                if (currentRecipient === '–æ–±—â–µ–µ') {
                    displayMessage(msg);
                    scrollToBottom();
                }
            }
        });

        socket.on('private_message', (msg) => {
            const recipient = msg.sender;
            addMessageToStore(recipient, msg);
            if (currentRecipient === recipient) {
                displayMessage(msg);
                scrollToBottom();
            }
        });
        
        socket.on('system_message', (content) => {
            const msg = { type: 'system', content: content };
            addMessageToStore('–æ–±—â–µ–µ', msg);
            if (currentRecipient === '–æ–±—â–µ–µ') {
                 displayMessage(msg);
                 scrollToBottom();
            }
        });

        // 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ Offer
        socket.on('incoming_call', ({ callerNickname, offerSdp }) => {
            if (isCalling) {
                socket.emit('call_busy', callerNickname);
                return;
            }
            
            currentCallTarget = callerNickname;
            
            callStatus.textContent = '–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫!';
            callPartner.textContent = `–ó–≤–æ–Ω–∏—Ç: ${callerNickname}`;
            callModal.style.display = 'flex';
            
            alert(`–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ${callerNickname}. –ù–∞–∂–º–∏—Ç–µ –û–ö, —á—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å.`);
            answerCall(offerSdp); 
        });

        // 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ Answer
        socket.on('webrtc_answer', async ({ answerSdp }) => {
            await handleAnswer(answerSdp);
            callStatus.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!';
            callPartner.textContent = `–í—ã –≤ —á–∞—Ç–µ —Å ${currentCallTarget}`;
            addMessageToStore(currentCallTarget, { type: 'system', content: `üìû –ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞—Ç.` });
            loadChat(currentCallTarget);
        });

        // 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–∞
        socket.on('webrtc_ice', async ({ candidate }) => {
            if (peerConnection) {
                try {
                    await peerConnection.addIceCandidate(candidate);
                } catch (e) {
                    console.error('Error adding received ICE candidate:', e);
                }
            }
        });

        // 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        socket.on('call_ended', (partner) => {
            if (isCalling && currentCallTarget === partner) {
                callStatus.textContent = `${partner} –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫.`;
                endCall();
            }
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto'; 
            this.style.height = (this.scrollHeight) + 'px';
            if (this.scrollHeight > 150) {
                this.style.height = '150px';
                this.style.overflowY = 'auto';
            } else {
                this.style.overflowY = 'hidden';
            }
        });

    </script>
</body>
</html>
