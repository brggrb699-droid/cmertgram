<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CmertGram</title>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    
    <style>
        :root {
            --color-primary: #FFD700; /* –ó–æ–ª–æ—Ç–∏—Å—Ç–æ-–∂–µ–ª—Ç—ã–π (–ó–∞–≥–æ–ª–æ–≤–∫–∏, –∞–∫—Ü–µ–Ω—Ç—ã) */
            --color-secondary: #007FFF; /* –Ø—Ä–∫–æ-—Å–∏–Ω–∏–π (–ö–Ω–æ–ø–∫–∏, –≤—ã–¥–µ–ª–µ–Ω–∏—è) */
            --color-background: #1e1e1e; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
            --color-text: #f0f0f0; /* –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç */
            --color-panel: #282c34; /* –§–æ–Ω –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏/–∫–∞—Ä—Ç–æ—á–µ–∫ */
            --color-input: #3a3f4b; /* –§–æ–Ω –ø–æ–ª—è –≤–≤–æ–¥–∞ */
            --color-system: #7F7F7F;
            --color-public-bg: #444444; /* –§–æ–Ω –ø—É–±–ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
            --color-private-bg: #007FFF40; /* –§–æ–Ω –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
            --color-my-message: #007FFF; /* –§–æ–Ω —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text);
            display: flex;
            height: 100vh;
            overflow: hidden;
            flex-direction: column;
        }

        /* –û–±—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã */
        #registration-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-background);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
        }
        
        #chat-container {
            display: none; 
            flex-direction: row;
            flex-grow: 1;
        }

        /* --- –ü–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–°–ª–µ–≤–∞) --- */
        #users-panel {
            width: 280px;
            min-width: 280px;
            background-color: var(--color-panel);
            padding: 15px 0;
            border-right: 1px solid #333;
            overflow-y: auto;
            flex-shrink: 0;
            position: relative;
            transition: transform 0.3s ease;
        }

        #users-panel h3 {
            color: var(--color-primary);
            padding: 0 15px;
            margin-top: 0;
            border-bottom: 1px solid var(--color-secondary);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        #users-list {
            list-style: none;
            padding: 0 15px;
            margin: 0;
        }

        #users-list li {
            padding: 10px;
            margin-bottom: 5px;
            background-color: var(--color-panel);
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--color-text);
        }

        #users-list li:hover {
            background-color: #3b3f49;
        }

        #users-list li.me {
            font-weight: bold;
            color: var(--color-primary);
            background-color: #3b3f49;
        }
        
        #users-list li.selected {
            background-color: var(--color-secondary);
            color: white;
        }
        
        /* --- –ü–∞–Ω–µ–ª—å —á–∞—Ç–∞ (–°–ø—Ä–∞–≤–∞) --- */
        #main-chat {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        #chat-header {
            padding: 15px;
            background-color: var(--color-panel);
            color: var(--color-primary);
            font-weight: bold;
            border-bottom: 1px solid var(--color-secondary);
            text-align: center;
            position: relative; /* –î–ª—è –∫–Ω–æ–ø–∫–∏ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é */
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        #menu-button {
            display: none;
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--color-primary);
            font-size: 24px;
            cursor: pointer;
        }

        #messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: var(--color-background);
        }

        /* --- –°–æ–æ–±—â–µ–Ω–∏—è --- */
        .message {
            max-width: 70%;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 15px;
            line-height: 1.4;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* –û–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–î—Ä—É–≥–∏–µ) */
        .message.public {
            background-color: var(--color-public-bg);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        /* –û–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–°–≤–æ–∏) */
        .message.public.self {
            background-color: var(--color-my-message);
            align-self: flex-end;
            color: white;
            border-bottom-right-radius: 5px;
        }

        /* –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message.private {
            background-color: var(--color-private-bg);
            border: 1px solid var(--color-secondary);
            align-self: flex-start;
            position: relative;
            border-bottom-left-radius: 5px;
        }
        
        .message.private.self {
            align-self: flex-end;
            background-color: var(--color-my-message);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        /* –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message.system {
            align-self: center;
            background-color: transparent;
            color: var(--color-system);
            text-align: center;
            font-style: italic;
            padding: 5px;
        }

        .message-sender {
            font-weight: bold;
            font-size: 0.9em;
            color: var(--color-primary);
            margin-bottom: 5px;
        }

        .message.public.self .message-sender,
        .message.private.self .message-sender {
            color: white;
        }

        .message-time {
            display: block;
            margin-top: 5px;
            font-size: 0.7em;
            color: #ccc;
            text-align: right;
        }

        /* --- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ --- */
        #input-form {
            display: flex;
            padding: 10px 15px;
            background-color: var(--color-panel);
            border-top: 1px solid #333;
        }

        #message-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 20px; /* –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
            background-color: var(--color-input);
            color: var(--color-text); /* **–¢–µ–∫—Å—Ç —Ç–µ–ø–µ—Ä—å —Å–≤–µ—Ç–ª—ã–π –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π** */
            font-size: 16px;
            resize: none;
            height: 40px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        #message-input:focus {
            border-color: var(--color-secondary);
            outline: none;
        }

        #input-form button {
            margin-left: 10px;
            background-color: var(--color-secondary);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #input-form button:hover {
            background-color: #006ED0;
        }

        /* --- –ú–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π (Context Menu) --- */
        #user-action-menu {
            position: fixed; 
            background-color: var(--color-input);
            border: 1px solid var(--color-secondary);
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            display: none;
            padding: 5px 0;
            min-width: 150px;
        }
        
        #user-action-menu button {
            /* –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é */
        }


        /* ================================================= */
        /* === –ê–î–ê–ü–¢–ò–í–ù–´–ô –î–ò–ó–ê–ô–ù (MOBILE RESPONSIVENESS) === */
        /* ================================================= */
        
        @media (max-width: 768px) {
            /* –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            #users-panel {
                position: absolute;
                height: 100%;
                z-index: 50;
                transform: translateX(-100%);
            }
            
            /* –ö–ª–∞—Å—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
            #users-panel.active {
                transform: translateX(0);
                box-shadow: 4px 0 10px rgba(0, 0, 0, 0.5);
            }
            
            /* –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–Ω–æ–ø–∫—É –º–µ–Ω—é –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            #menu-button {
                display: block;
            }
            
            /* –†–µ–≥—É–ª–∏—Ä—É–µ–º –æ—Ç—Å—Ç—É–ø—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ —á–∞—Ç–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å –∫–Ω–æ–ø–∫–æ–π –º–µ–Ω—é */
            #chat-header {
                padding-left: 50px;
            }
            
            /* –£–º–µ–Ω—å—à–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏–π, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –∑–∞–Ω–∏–º–∞–ª–∏ 100% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞ */
            .message {
                max-width: 90%;
            }
            
            /* –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞, –µ—Å–ª–∏ –æ–Ω –º–µ—à–∞–µ—Ç */
            #recipient-indicator {
                left: 5%;
                right: 5%;
            }
        }
    </style>
</head>
<body>

    <div id="user-action-menu">
        </div>

    <div id="registration-screen">
        <h1>CmertGram</h1>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º (–±–µ–∑ –ø–∞—Ä–æ–ª—è/email):</p>
        <input type="text" id="nickname-input" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" maxlength="15">
        <button id="register-button">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
        <div id="registration-error"></div>
    </div>

    <div id="chat-container">
        <div id="users-panel">
            <h3>üë• –û–Ω–ª–∞–π–Ω –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
            <ul id="users-list">
                </ul>
        </div>

        <div id="main-chat">
            <button id="menu-button" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">‚ò∞</button>
            <div id="chat-header">
                –û–±—â–∏–π –ß–∞—Ç (Default)
            </div>
            
            <div id="recipient-indicator">
                –í—ã –ø–∏—à–µ—Ç–µ: <span id="current-recipient"></span>. <a href="#" id="exit-private" style="color: var(--color-background); text-decoration: none;">[X] –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –û–±—â–∏–π</a>
            </div>

            <div id="messages">
                </div>

            <form id="input-form">
                <textarea id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <script>
        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        
        const socket = io({
             transports: ['websocket'] 
        });

        const AES_KEY = '–≠—Ç–æ_–û—á–µ–Ω—å_–°–µ–∫—Ä–µ—Ç–Ω—ã–π_–ö–ª—é—á_AES'; 
        let myNickname = '';
        let currentRecipient = null; 
        let lastUserList = [];

        // --- DOM —ç–ª–µ–º–µ–Ω—Ç—ã ---
        const regScreen = document.getElementById('registration-screen');
        const chatContainer = document.getElementById('chat-container');
        const nicknameInput = document.getElementById('nickname-input');
        const registerButton = document.getElementById('register-button');
        const regError = document.getElementById('registration-error');
        const usersPanel = document.getElementById('users-panel'); // –î–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏
        const menuButton = document.getElementById('menu-button'); // –î–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏
        const usersList = document.getElementById('users-list');
        const messagesDiv = document.getElementById('messages');
        const inputForm = document.getElementById('input-form');
        const messageInput = document.getElementById('message-input');
        const chatHeader = document.getElementById('chat-header');
        const recipientIndicator = document.getElementById('recipient-indicator');
        const currentRecipientSpan = document.getElementById('current-recipient');
        const exitPrivateLink = document.getElementById('exit-private');
        const actionMenu = document.getElementById('user-action-menu');

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
        document.addEventListener('click', (e) => {
            if (actionMenu.style.display === 'block' && !actionMenu.contains(e.target) && !e.target.closest('#users-list li:not(.me)')) {
                actionMenu.style.display = 'none';
            }
        });
        
        // --- Crypto (–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ/–î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ) ---
        
        function encrypt(text) {
            try {
                const key = CryptoJS.enc.Utf8.parse(AES_KEY);
                const encrypted = CryptoJS.AES.encrypt(text, key, {
                    mode: CryptoJS.mode.ECB,
                    padding: CryptoJS.pad.Pkcs7
                });
                return encrypted.toString();
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:", e);
                return text;
            }
        }

        function decrypt(encryptedText) {
            try {
                const key = CryptoJS.enc.Utf8.parse(AES_KEY);
                const decrypted = CryptoJS.AES.decrypt(encryptedText, key, {
                    mode: CryptoJS.mode.ECB,
                    padding: CryptoJS.pad.Pkcs7
                });
                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ:", e);
                return `[–ù–ï –ú–û–ñ–ï–¢ –ë–´–¢–¨ –î–ï–®–ò–§–†–û–í–ê–ù–û: ${encryptedText.substring(0, 30)}...]`;
            }
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ UI ---
        
        function showUserActionMenu(user, event) {
            actionMenu.style.display = 'none'; 
            
            actionMenu.innerHTML = `
                <button onclick="startPrivateChat('${user}'); hideActionMenu();">üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ</button>
                <button onclick="startCall('${user}'); hideActionMenu();">üìû –ó–≤–æ–Ω–æ–∫ (–ó–∞–≥–ª—É—à–∫–∞)</button>
            `;
            
            actionMenu.style.top = `${event.clientY}px`;
            
            // –†–∞—Å—á–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –º–µ–Ω—é, —á—Ç–æ–±—ã –æ–Ω–æ –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–æ –∑–∞ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π
            const menuWidth = 150; 
            if (event.clientX + menuWidth > window.innerWidth) {
                 actionMenu.style.left = `${window.innerWidth - menuWidth - 10}px`;
            } else {
                 actionMenu.style.left = `${event.clientX}px`;
            }

            actionMenu.style.display = 'block';
            
            event.preventDefault(); 
        }

        function hideActionMenu() {
            actionMenu.style.display = 'none';
        }
        
        function startCall(recipient) {
            const time = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            const msg = {
                 type: 'system', 
                 sender: '–°–∏—Å—Ç–µ–º–∞', 
                 content: `üìû –í—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –ø–æ–∑–≤–æ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é **${recipient}**... (–§—É–Ω–∫—Ü–∏—è –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞). –í—Ä–µ–º—è: ${time}` 
            };
            addMessage(msg, true);
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addMessage(msg, isSelf = false, recipient = null) {
            const isSystem = msg.type === 'system';
            const isPrivate = msg.type === 'private';
            const messageDiv = document.createElement('div');
            
            let classes = ['message'];
            if (isSystem) {
                classes.push('system');
            } else if (isPrivate) {
                classes.push('private');
                if (isSelf) classes.push('self');
            } else {
                classes.push('public');
                if (isSelf) classes.push('self');
            }
            messageDiv.className = classes.join(' ');

            const content = isSystem ? msg.content : decrypt(msg.content);
            
            if (isSystem) {
                const formattedContent = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                messageDiv.innerHTML = `<div class="message-content">${formattedContent}</div>`;
            } else {
                let senderText = isPrivate && isSelf ? `–í—ã (–¥–ª—è ${recipient})` : 
                                 isPrivate && !isSelf ? `üîí ${msg.sender} (–ü—Ä–∏–≤–∞—Ç–Ω–æ)` : 
                                 msg.sender;
                
                messageDiv.innerHTML = `
                    <div class="message-sender">${senderText}</div>
                    <div class="message-content">${content}</div>
                    <div class="message-time">${msg.timestamp}</div>
                `;
            }

            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        function updateUsersList(users) {
            lastUserList = users;
            usersList.innerHTML = '';
            
            const sortedUsers = users.sort((a, b) => {
                if (a === myNickname) return -1;
                if (b === myNickname) return 1;
                return a.localeCompare(b);
            });

            sortedUsers.forEach(user => {
                const li = document.createElement('li');
                li.textContent = user;
                if (user === myNickname) {
                    li.classList.add('me');
                } else {
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é (–ø—Ä–∞–≤–∞—è/–ª–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏)
                    li.oncontextmenu = (e) => showUserActionMenu(user, e); 
                    li.onclick = (e) => {
                        // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –ø–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π
                        if (window.innerWidth <= 768) {
                            showUserActionMenu(user, e);
                        } else {
                            // –ù–∞ –ü–ö, –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç —Å—Ä–∞–∑—É –ø–æ –∫–ª–∏–∫—É
                            startPrivateChat(user);
                        }
                    };
                }
                if (user === currentRecipient) {
                     li.classList.add('selected');
                }
                usersList.appendChild(li);
            });
        }
        
        function startPrivateChat(recipient) {
            if (recipient === myNickname) return;
            currentRecipient = recipient;
            chatHeader.textContent = `–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –ß–∞—Ç —Å ${recipient}`;
            recipientIndicator.style.display = 'block';
            currentRecipientSpan.textContent = recipient;
            
            updateUsersList(lastUserList);
            messageInput.focus();
            
            // –°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
            if (window.innerWidth <= 768) {
                usersPanel.classList.remove('active');
            }
        }
        
        function exitPrivateChat() {
            currentRecipient = null;
            chatHeader.textContent = '–û–±—â–∏–π –ß–∞—Ç (Default)';
            recipientIndicator.style.display = 'none';
            
            updateUsersList(lastUserList);
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π DOM ---

        // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        menuButton.onclick = () => {
            usersPanel.classList.toggle('active');
        };
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        registerButton.onclick = () => {
            const nickname = nicknameInput.value.trim();
            if (nickname) {
                socket.emit('register', nickname);
            }
        };
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        inputForm.onsubmit = (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();

            if (messageText) {
                const encryptedContent = encrypt(messageText);

                if (currentRecipient) {
                    socket.emit('private_message', {
                        recipientNickname: currentRecipient,
                        encryptedContent: encryptedContent
                    });
                } else {
                    socket.emit('public_message', encryptedContent);
                }
                
                messageInput.value = '';
                messageInput.style.height = '40px';
            }
        };
        
        // –°–±—Ä–æ—Å –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞
        exitPrivateLink.onclick = (e) => {
            e.preventDefault();
            exitPrivateChat();
        };

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto'; 
            this.style.height = (this.scrollHeight) + 'px';
            if (this.scrollHeight > 150) {
                this.style.height = '150px';
                this.style.overflowY = 'auto';
            } else {
                this.style.overflowY = 'hidden';
            }
        });

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Socket.io ---

        socket.on('registration_success', (nickname) => {
            myNickname = nickname;
            regScreen.style.display = 'none';
            chatContainer.style.display = 'flex';
            chatHeader.textContent = `–û–±—â–∏–π –ß–∞—Ç (–í–∞—à –Ω–∏–∫: ${myNickname})`;
            messageInput.focus();
        });

        socket.on('registration_error', (error) => {
            regError.textContent = error;
        });

        socket.on('user_list', (users) => {
            updateUsersList(users);
        });

        socket.on('public_message', (msg) => {
            const isSelf = msg.sender === myNickname;
            addMessage(msg, isSelf);
        });

        socket.on('private_message', (msg) => {
            const isSelf = msg.sender === myNickname;
            const recipientNickname = msg.recipient;
            
            // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –º–µ–Ω—è, –∏ —É –º–µ–Ω—è –æ—Ç–∫—Ä—ã—Ç —á–∞—Ç —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º –ò–õ–ò –æ—Ç–∫—Ä—ã—Ç –æ–±—â–∏–π —á–∞—Ç
            if (!isSelf && (currentRecipient === msg.sender || currentRecipient === null)) {
                 addMessage(msg, false);
            } 
            // –ï—Å–ª–∏ —ç—Ç–æ –º–æ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ –æ—Ç–∫—Ä—ã—Ç —á–∞—Ç —Å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º –ò–õ–ò –æ—Ç–∫—Ä—ã—Ç –æ–±—â–∏–π —á–∞—Ç
            else if (isSelf && (currentRecipient === recipientNickname || currentRecipient === null)) {
                 addMessage(msg, true, recipientNickname);
            }
            
            // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ –Ω–æ–≤–æ–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–æ –æ—Ç–∫—Ä—ã—Ç –¥—Ä—É–≥–æ–π —á–∞—Ç
            else if (!isSelf && currentRecipient !== msg.sender) {
                 // –¢—É—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ)
                 console.log(`–ù–æ–≤–æ–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${msg.sender}. –ü–æ–∫–∞–∂—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.`);
            }
        });
        
    </script>
</body>
</html>
