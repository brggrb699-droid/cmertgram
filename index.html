<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGram</title>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        :root {
            /* –¶–≤–µ—Ç–∞ Telegram-—Å—Ç–∏–ª—è */
            --tg-blue: #0088CC; /* –û—Å–Ω–æ–≤–Ω–æ–π —Å–∏–Ω–∏–π */
            --tg-dark: #1F2C3D; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –ø–∞–Ω–µ–ª–µ–π */
            --tg-bg: #1A2433; /* –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω —á–∞—Ç–∞ */
            --tg-text: #E0E0E0; /* –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç */
            --tg-accent: #65A30D; /* –ó–µ–ª–µ–Ω—ã–π (–°—Ç–∞—Ç—É—Å/–ê–∫—Ü–µ–Ω—Ç) */
            --tg-message-self: #4A9C4A; /* –¶–≤–µ—Ç —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
            --tg-message-other: #334455; /* –¶–≤–µ—Ç —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* –û–±—â–∞—è —Å–µ—Ç–∫–∞ */
        #registration-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--tg-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
        }
        
        #registration-screen input, #registration-screen button {
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            margin: 5px;
            width: 80%;
            max-width: 300px;
        }

        #registration-screen input {
            background-color: var(--tg-dark);
            border: 1px solid #333;
            color: var(--tg-text);
        }

        #registration-screen button {
            background-color: var(--tg-blue);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #chat-container {
            display: none; 
            flex-grow: 1;
            display: flex;
        }

        /* --- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å (–°–ø–∏—Å–∫–∏ —á–∞—Ç–æ–≤) --- */
        #chat-list-panel {
            width: 350px;
            min-width: 250px;
            background-color: var(--tg-dark);
            border-right: 1px solid #333;
            overflow-y: auto;
            flex-shrink: 0;
            position: relative;
        }

        #chat-list-panel h3 {
            padding: 15px;
            margin: 0;
            border-bottom: 1px solid #333;
            color: var(--tg-text);
            font-size: 1.2em;
        }

        #chat-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #chat-list li {
            padding: 15px;
            border-bottom: 1px solid #29384B;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #chat-list li:hover {
            background-color: #29384B;
        }

        #chat-list li.active {
            background-color: var(--tg-blue);
            color: white;
        }
        
        /* --- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–ß–∞—Ç) --- */
        #main-chat {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--tg-bg);
        }
        
        #chat-header {
            padding: 15px;
            background-color: var(--tg-dark);
            border-bottom: 1px solid #333;
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #messages {
            flex-grow: 1;
            padding: 10px 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .message {
            max-width: 60%;
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word;
            font-size: 0.95em;
        }
        
        /* –°–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message.self {
            background-color: var(--tg-message-self);
            align-self: flex-end;
            color: white;
            border-bottom-right-radius: 4px;
        }

        /* –ß—É–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message.other {
            background-color: var(--tg-message-other);
            align-self: flex-start;
            color: var(--tg-text);
            border-bottom-left-radius: 4px;
        }
        
        .message.system {
            align-self: center;
            background-color: transparent;
            color: var(--tg-accent);
            text-align: center;
            font-size: 0.8em;
            padding: 5px;
        }

        .message-sender {
            font-weight: bold;
            color: var(--tg-accent);
            margin-bottom: 3px;
        }
        
        .message.self .message-sender {
            color: white;
        }

        .message-time {
            display: block;
            margin-top: 3px;
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.6);
            text-align: right;
        }

        /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ */
        #input-form {
            display: flex;
            padding: 10px 15px;
            background-color: var(--tg-dark);
            border-top: 1px solid #333;
        }

        #message-input {
            flex-grow: 1;
            padding: 10px;
            border: none;
            border-radius: 20px; 
            background-color: #334455;
            color: var(--tg-text); 
            font-size: 16px;
            resize: none;
            height: 40px;
            box-sizing: border-box;
            line-height: 20px;
        }

        #message-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--tg-blue);
        }

        #input-form button {
            margin-left: 10px;
            background-color: var(--tg-blue);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        #input-form button:hover {
            background-color: #0077B3;
        }
        
        /* --- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å --- */
        @media (max-width: 800px) {
            #chat-list-panel {
                width: 100%;
                position: fixed;
                height: 100%;
                z-index: 10;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            
            #chat-list-panel.active {
                transform: translateX(0);
            }
            
            #main-chat {
                flex-grow: 1;
                width: 100%;
            }
            
            .menu-toggle {
                display: block !important;
                background: none;
                border: none;
                color: var(--tg-text);
                font-size: 24px;
                cursor: pointer;
                padding: 0 10px 0 0;
            }
        }
        
        .menu-toggle {
            display: none;
        }

    </style>
</head>
<body>

    <div id="registration-screen">
        <h1>WebGram</h1>
        <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º –¥–ª—è –≤—Ö–æ–¥–∞:</p>
        <input type="text" id="nickname-input" placeholder="–ù–∏–∫–Ω–µ–π–º" maxlength="15">
        <button id="register-button">–í–æ–π—Ç–∏</button>
        <div id="registration-error" style="color: red; margin-top: 10px;"></div>
    </div>

    <div id="chat-container">
        
        <div id="chat-list-panel">
            <h3>üë• –ß–∞—Ç—ã</h3>
            <ul id="chat-list">
                <li id="general-chat-item" class="active" data-recipient="–æ–±—â–µ–µ">
                    –û–±—â–∏–π –ß–∞—Ç
                </li>
            </ul>
        </div>

        <div id="main-chat">
            <div id="chat-header">
                <button class="menu-toggle" id="menu-toggle-btn">‚ò∞</button>
                <span id="current-chat-title">–û–±—â–∏–π –ß–∞—Ç</span>
                <span style="font-size: 0.8em; color: var(--tg-accent);">Online</span>
            </div>
            
            <div id="messages">
                </div>

            <form id="input-form">
                <textarea id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <script>
        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        const socket = io({ transports: ['websocket'] });
        let myNickname = '';
        let currentRecipient = '–æ–±—â–µ–µ'; // '–æ–±—â–µ–µ' –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º
        let allUsers = []; // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

        // --- DOM —ç–ª–µ–º–µ–Ω—Ç—ã ---
        const regScreen = document.getElementById('registration-screen');
        const chatContainer = document.getElementById('chat-container');
        const nicknameInput = document.getElementById('nickname-input');
        const registerButton = document.getElementById('register-button');
        const regError = document.getElementById('registration-error');
        const chatListPanel = document.getElementById('chat-list-panel');
        const chatList = document.getElementById('chat-list');
        const messagesDiv = document.getElementById('messages');
        const inputForm = document.getElementById('input-form');
        const messageInput = document.getElementById('message-input');
        const currentChatTitle = document.getElementById('current-chat-title');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        
        // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ–æ–±—â–µ–Ω–∏–π: { '–æ–±—â–µ–µ': [...], 'nickname': [...] }
        const messageStore = { '–æ–±—â–µ–µ': [] };

        // --- –§—É–Ω–∫—Ü–∏–∏ UI ---
        
        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addMessageToStore(recipient, msg) {
            if (!messageStore[recipient]) {
                messageStore[recipient] = [];
            }
            messageStore[recipient].push(msg);
        }

        function displayMessage(msg) {
            const isSystem = msg.type === 'system';
            const messageDiv = document.createElement('div');
            
            let classes = ['message'];
            if (isSystem) {
                classes.push('system');
            } else if (msg.sender === myNickname) {
                classes.push('self');
            } else {
                classes.push('other');
            }
            messageDiv.className = classes.join(' ');

            const senderName = msg.sender === myNickname ? '–í—ã' : msg.sender;
            const time = msg.timestamp || new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            
            if (isSystem) {
                messageDiv.innerHTML = `<span>${msg.content}</span>`;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">${msg.content}</div>
                    <div class="message-time">${time}</div>
                `;
            }

            messagesDiv.appendChild(messageDiv);
        }
        
        function loadChat(recipient) {
            currentRecipient = recipient;
            messagesDiv.innerHTML = '';
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            if (recipient === '–æ–±—â–µ–µ') {
                currentChatTitle.textContent = '–û–±—â–∏–π –ß–∞—Ç';
            } else {
                currentChatTitle.textContent = `–ß–∞—Ç —Å ${recipient}`;
            }

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ
            document.querySelectorAll('#chat-list li').forEach(li => {
                li.classList.remove('active');
                if (li.dataset.recipient === recipient) {
                    li.classList.add('active');
                }
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            const messages = messageStore[recipient] || [];
            messages.forEach(displayMessage);
            scrollToBottom();
            
            // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö: –∑–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —á–∞—Ç–æ–≤
            if (window.innerWidth <= 800) {
                chatListPanel.classList.remove('active');
            }
            
            messageInput.focus();
        }

        function updateChatList(users) {
            allUsers = users;
            chatList.innerHTML = '';

            // 1. –û–±—â–∏–π —á–∞—Ç
            const generalLi = document.createElement('li');
            generalLi.id = 'general-chat-item';
            generalLi.textContent = '–û–±—â–∏–π –ß–∞—Ç';
            generalLi.dataset.recipient = '–æ–±—â–µ–µ';
            generalLi.onclick = () => loadChat('–æ–±—â–µ–µ');
            if (currentRecipient === '–æ–±—â–µ–µ') generalLi.classList.add('active');
            chatList.appendChild(generalLi);
            
            // 2. –õ–∏—á–Ω—ã–µ —á–∞—Ç—ã
            users.filter(user => user !== myNickname).forEach(user => {
                const li = document.createElement('li');
                li.textContent = user;
                li.dataset.recipient = user;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å—Ç–æ—Ä–µ, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                if (!messageStore[user]) {
                    messageStore[user] = [];
                }
                
                li.onclick = () => loadChat(user);
                if (currentRecipient === user) li.classList.add('active');
                chatList.appendChild(li);
            });
            
            // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—É—á–∞—Ç–µ–ª—å —É—à–µ–ª, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –æ–±—â–∏–π —á–∞—Ç
            if (currentRecipient !== '–æ–±—â–µ–µ' && !users.includes(currentRecipient)) {
                 loadChat('–æ–±—â–µ–µ');
            }
        }
        
        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ DOM ---
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        registerButton.onclick = () => {
            const nickname = nicknameInput.value.trim();
            if (nickname) {
                socket.emit('register', nickname);
            }
        };
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        inputForm.onsubmit = (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();

            if (messageText) {
                const msg = {
                    sender: myNickname,
                    content: messageText,
                    timestamp: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
                };

                if (currentRecipient === '–æ–±—â–µ–µ') {
                    socket.emit('public_message', msg);
                } else {
                    msg.recipient = currentRecipient;
                    socket.emit('private_message', msg);
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
                addMessageToStore(currentRecipient, msg);
                if (currentRecipient !== '–æ–±—â–µ–µ') {
                    // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –æ–±—â–µ–≥–æ —á–∞—Ç–∞, —á—Ç–æ–±—ã —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –±—ã–ª–∏ –≤–∏–¥–Ω—ã
                    // addMessageToStore('–æ–±—â–µ–µ', {...msg, type: 'system', content: `[–õ–ò–ß–ù–û –¥–ª—è ${currentRecipient}] ${messageText}`});
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                loadChat(currentRecipient);
                
                messageInput.value = '';
                messageInput.style.height = '40px';
            }
        };
        
        // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å: –æ—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
        menuToggleBtn.onclick = () => {
            chatListPanel.classList.toggle('active');
        };

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto'; 
            this.style.height = (this.scrollHeight) + 'px';
            if (this.scrollHeight > 150) {
                this.style.height = '150px';
                this.style.overflowY = 'auto';
            } else {
                this.style.overflowY = 'hidden';
            }
        });


        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Socket.io ---

        socket.on('registration_success', (nickname) => {
            myNickname = nickname;
            regScreen.style.display = 'none';
            chatContainer.style.display = 'flex';
            loadChat('–æ–±—â–µ–µ'); // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—â–µ–≥–æ —á–∞—Ç–∞
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤—Ö–æ–¥–µ
            addMessageToStore('–æ–±—â–µ–µ', {
                 type: 'system', 
                 content: `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ WebGram, ${nickname}!` 
            });
            loadChat('–æ–±—â–µ–µ');
        });

        socket.on('registration_error', (error) => {
            regError.textContent = error;
        });

        socket.on('user_list', (users) => {
            updateChatList(users);
        });

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        socket.on('public_message', (msg) => {
            if (msg.sender !== myNickname) {
                addMessageToStore('–æ–±—â–µ–µ', msg);
                if (currentRecipient === '–æ–±—â–µ–µ') {
                    displayMessage(msg);
                    scrollToBottom();
                }
            }
        });
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–∏—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        socket.on('private_message', (msg) => {
            const recipient = msg.sender; // –¢.–∫. —ç—Ç–æ –¥–ª—è –º–µ–Ω—è, –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å ‚Äî —ç—Ç–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –≤ –º–æ–µ–π –∏—Å—Ç–æ—Ä–∏–∏
            
            addMessageToStore(recipient, msg);
            
            // –ï—Å–ª–∏ —è –≤ —á–∞—Ç–µ —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º, –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
            if (currentRecipient === recipient) {
                displayMessage(msg);
                scrollToBottom();
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)
                updateChatList(allUsers);
            }
        });
        
        // –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –≤—Ö–æ–¥–µ/–≤—ã—Ö–æ–¥–µ
        socket.on('system_message', (content) => {
            const msg = { type: 'system', content: content };
            addMessageToStore('–æ–±—â–µ–µ', msg);
            if (currentRecipient === '–æ–±—â–µ–µ') {
                 displayMessage(msg);
                 scrollToBottom();
            }
        });
        
    </script>
</body>
</html>
